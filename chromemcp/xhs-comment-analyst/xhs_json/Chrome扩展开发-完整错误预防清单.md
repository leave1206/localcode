# 🚨 Chrome扩展开发 - 完整错误预防清单

## 📋 核心错误分类

### 1. 🔄 异步编程与通信错误
**高频错误模式：**
- ❌ 同步调用异步函数，Promise未正确处理
- ❌ 过早发送消息：background.js在content.js完全加载前就发送消息
- ❌ Promise链断裂：scheduleNextCollection调用async函数未await
- ❌ 回调地狱：混用Promise和callback导致错误处理复杂
- ❌ 消息发送后立即执行：没有等待消息处理完成就执行后续操作
- ❌ 缺少重试机制：通信失败时没有适当的重试逻辑
- ❌ 异步函数调用链不完整
- ❌ 跨脚本通信未处理连接失败情况

**检查要点：**
- [ ] 所有Promise都有proper的await/then处理
- [ ] 消息发送有重试机制和超时处理
- [ ] 等待异步操作完成再执行后续逻辑
- [ ] 错误处理覆盖所有异步操作
- [ ] 避免Promise和callback混用

### 2. 📊 状态管理错误
**错误模式：**
- ❌ 全局状态污染：monitorProgress影响不相关的品牌操作
- ❌ 状态不一致：前端显示与后端实际状态不同步
- ❌ 状态初始化错误：缺少status字段或默认值设置错误
- ❌ 状态转换逻辑错误：completed状态下仍阻止新任务添加
- ❌ 多个状态源冲突：优先级处理不当
- ❌ 状态清理逻辑缺失：导致内存泄漏或状态污染
- ❌ 异步状态更新时序问题：竞态条件未处理

**检查要点：**
- [ ] 全局状态只影响应该影响的组件/功能
- [ ] 状态初始化包含所有必要字段和正确默认值
- [ ] 状态转换逻辑清晰，无循环依赖
- [ ] 前端状态与后端状态同步机制正确
- [ ] 所有可能的状态值都有UI显示定义
- [ ] 多个状态源之间的冲突和优先级处理正确
- [ ] 状态清理逻辑完整

### 3. ⚡ 并发控制与队列管理错误
**错误模式：**
- ❌ 过度并发限制：不同品牌任务被错误地互相阻塞
- ❌ 队列逻辑混乱：立即任务与定时任务优先级处理错误
- ❌ 死锁风险：isProcessingCollection标志未正确清理
- ❌ 任务去重逻辑错误：同品牌不同类型任务无法正确替换
- ❌ 并发操作预期行为不明确（允许/拒绝/排队）
- ❌ 锁和标志变量使用不当

**检查要点：**
- [ ] 明确定义并发操作的预期行为（允许/拒绝/排队）
- [ ] 检查所有可能的并发场景
- [ ] 验证锁和标志变量的正确使用
- [ ] 确保竞态条件被妥善处理
- [ ] 并发限制逻辑精确，不过度限制无关操作
- [ ] 队列处理顺序符合业务需求
- [ ] 避免死锁和资源竞争

### 4. 🎯 函数作用域与引用错误
**错误模式：**
- ❌ 函数定义在局部作用域：函数定义在事件监听器内部，外部无法访问
- ❌ 变量提升问题：在声明前使用变量或函数
- ❌ 闭包引用错误：闭包中引用了会变化的外部变量
- ❌ 函数职责不清：单个函数承担过多职责

**检查要点：**
- [ ] 需要全局调用的函数定义在全局作用域
- [ ] 避免在函数声明前调用函数
- [ ] 闭包中正确引用外部变量
- [ ] 事件处理函数能正确访问所需的上下文
- [ ] 每个函数只做一件事（单一职责原则）

### 5. 🎧 事件监听与内存管理错误
**错误模式：**
- ❌ 重复绑定事件：没有清理旧的事件监听器就添加新的
- ❌ 监听器泄露：临时监听器没有及时清理
- ❌ 条件监听缺失：不检查条件就执行事件处理逻辑
- ❌ 事件监听器泄露导致内存泄露和重复执行

**检查要点：**
- [ ] 添加新监听器前清理旧监听器
- [ ] 临时监听器在适当时机被清理
- [ ] 事件处理逻辑检查执行条件
- [ ] 避免重复绑定相同的事件处理器

### 6. 🔒 安全检查与权限错误
**错误模式：**
- ❌ 缺少安全检查：直接操作页面而不检查页面类型
- ❌ 权限假设错误：假设content script有所有权限
- ❌ 跨域操作错误：在不合适的上下文中执行操作
- ❌ 权限和API可用性未验证

**检查要点：**
- [ ] 页面操作前验证页面类型和域名
- [ ] 避免在插件页面执行目标网站的操作
- [ ] content script权限足够执行预期操作
- [ ] 有备用方案处理权限不足的情况
- [ ] 权限和API可用性验证

### 7. 🏗️ 多任务管理错误
**错误模式：**
- ❌ 任务身份混淆：操作时不明确是针对哪个任务
- ❌ 默认值逻辑错误：使用错误的默认任务
- ❌ 任务切换状态错误：切换任务时状态没有正确更新
- ❌ 多任务状态混淆：导致操作错误的任务

**检查要点：**
- [ ] 操作时明确指定目标任务ID
- [ ] 避免使用错误的默认任务逻辑
- [ ] 任务切换时正确更新所有相关状态
- [ ] 按钮和UI元素正确绑定到当前选中的任务

### 8. 🔍 数据验证与类型错误
**错误模式：**
- ❌ 类型假设错误：假设brandId是number但实际可能是字符串
- ❌ 空值处理缺失：未检查null/undefined导致运行时错误
- ❌ 数据结构假设：假设数组/对象结构但未验证
- ❌ 边界条件忽略：空队列、空品牌列表等极端情况
- ❌ 输入参数类型和有效性验证缺失

**检查要点：**
- [ ] 所有输入参数进行类型和有效性验证
- [ ] 处理null/undefined/空值情况
- [ ] 边界条件和极端情况覆盖完整
- [ ] 数据结构假设有验证保护
- [ ] 数据格式在存储和读取时保持一致

### 9. 💾 数据存储与检索错误
**错误模式：**
- ❌ 键名硬编码：存储键名分散在代码各处，难以维护
- ❌ 数据格式不一致：存储和读取时数据结构不匹配
- ❌ 缺少默认值：读取数据时不处理undefined情况

**检查要点：**
- [ ] 存储键名通过函数统一管理
- [ ] 读取数据时处理undefined/null情况
- [ ] 数据格式在存储和读取时保持一致
- [ ] 有数据迁移和兼容性处理

### 10. 💬 用户体验与错误反馈错误
**错误模式：**
- ❌ 错误提示不准确：通用错误信息无法帮助用户定位问题
- ❌ 状态反馈滞后：UI状态更新不及时或不准确
- ❌ 操作反馈缺失：用户操作后无明确成功/失败反馈
- ❌ 错误恢复机制缺失：错误发生后UI状态无法正确恢复
- ❌ 静默失败：错误发生时不给用户任何提示

**检查要点：**
- [ ] 错误提示使用用户友好的语言
- [ ] 成功/失败状态清晰可区分
- [ ] 长时间操作提供适当的进度反馈
- [ ] 异常情况有恰当的处理和提示
- [ ] 操作结果符合用户预期
- [ ] 错误后有恢复机制

### 11. 🔧 Chrome扩展特定错误
**错误模式：**
- ❌ 消息传递错误处理：chrome.runtime.sendMessage错误未捕获
- ❌ 存储API误用：chrome.storage.local异步特性处理错误
- ❌ 权限假设错误：假设所有API都可用但未验证权限
- ❌ 标签管理错误：操作已关闭或无效的标签页

**检查要点：**
- [ ] 所有chrome API调用有错误处理
- [ ] 消息传递机制robust
- [ ] 权限和API可用性验证
- [ ] 标签页生命周期管理正确

### 12. 📝 代码质量与维护性错误
**错误模式：**
- ❌ 重复代码：相同函数定义多次
- ❌ 硬编码常量：magic number和字符串散布在代码中
- ❌ 向后兼容过度：保留过多旧版本兼容代码影响可读性
- ❌ 引入不必要的复杂性
- ❌ 修改破坏现有功能

**检查要点：**
- [ ] 避免引入不必要的复杂性
- [ ] 确保修改不会破坏现有功能
- [ ] 保持代码的可读性和可维护性
- [ ] 添加必要的日志用于调试
- [ ] 验证修改的副作用

## 🔥 高频致命错误（必须避免）
1. **异步通信时序错误** - 导致"Could not establish connection"
2. **多任务状态混淆** - 导致操作错误的任务
3. **函数作用域错误** - 导致"function is not defined"
4. **安全检查缺失** - 导致意外关闭插件页面

## ⚡ 隐蔽错误（容易忽略）
1. **事件监听器泄露** - 导致内存泄露和重复执行
2. **状态同步延迟** - 导致UI显示与实际状态不符
3. **错误恢复缺失** - 导致系统进入不可恢复状态
4. **边界条件处理** - 导致极端情况下的崩溃

## 🧪 关键测试场景
- [ ] 多任务并行执行情况
- [ ] 网络异常和页面加载失败情况
- [ ] 任务切换时的状态一致性
- [ ] 边界条件（如空数据、极大数据）
- [ ] 主要使用场景的完整流程
- [ ] 并发操作的表现
- [ ] 用户反馈的准确性

## 💡 最佳实践原则
1. **防御性编程**：假设所有外部输入都不可信
2. **单一职责**：每个函数只做一件事
3. **明确错误处理**：每个可能失败的操作都有错误处理
4. **状态隔离**：组件间状态影响最小化
5. **可调试性**：关键流程有日志，便于问题定位
6. **简单优先**：优先选择最简单的解决方案
7. **用户至上**：确保修改符合用户的实际需求

## ⚠️ 常见陷阱提醒
- 不要假设异步操作立即完成
- 不要让全局状态影响无关的功能模块
- 不要忽略用户的错误操作场景
- 不要依赖未经验证的数据结构
- 不要让一个组件的错误影响整个系统
- 不要为了技术炫技而过度设计
- 不要在修改前忽略理解当前代码行为

使用此清单作为代码审查模板，在每次提交前运行完整的检查流程，特别关注多任务管理和异步通信部分。
