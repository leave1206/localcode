<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¥é”€ç­–ç•¥å·¥ä½œæµè‡ªåŠ¨åŒ–ï¼ˆçº¯APIè°ƒç”¨ç‰ˆï¼‰</title>
    <!-- å¼•å…¥Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥SheetJS (xlsx.js) ç”¨äºç”ŸæˆExcelæ–‡ä»¶ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- å¼•å…¥Marked.js ç”¨äºå°†Markdownè½¬æ¢ä¸ºHTMLé¢„è§ˆ -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- å¼•å…¥ PDF.js for PDF text extraction -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', 'Noto Sans SC', sans-serif;
            background-color: #f8fafc;
        }
        .status-item {
            transition: all 0.3s ease-in-out;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .status-item.pending {
            opacity: 0.5;
        }
        .status-item.processing {
            opacity: 1;
            transform: scale(1.05);
            border-left-color: #3b82f6;
        }
        .status-item.completed {
            opacity: 1;
            border-left-color: #22c55e;
        }
        .status-item.error {
             opacity: 1;
             border-left-color: #ef4444;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 0.5rem;
            max-width: 80vw;
            max-height: 80vh;
            overflow-y: auto;
        }
        .file-upload-feedback {
            font-size: 0.8rem;
            color: #16a34a;
            margin-top: 4px;
            height: 1rem;
        }
        .spinner {
            display: inline-block;
            border: 2px solid rgba(0,0,0,.1);
            border-left-color: #3b82f6;
            border-radius: 50%;
            width: 14px;
            height: 14px;
            animation: spin 1s linear infinite;
            margin-right: 8px;
            vertical-align: middle;
        }
        .download-icon {
            cursor: pointer;
            color: #9ca3af;
            transition: color 0.2s;
        }
        .download-icon:hover {
            color: #3b82f6;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-10">
            <h1 class="text-4xl font-bold text-gray-900">è¥é”€ç­–ç•¥å·¥ä½œæµè‡ªåŠ¨åŒ–å¹³å°</h1>
            <p class="text-lg text-gray-600 mt-2">åŸºäº Gemini API çš„çœŸå®è¥é”€æ´å¯Ÿä¸å†…å®¹ç”Ÿæˆ</p>
        </header>

        <main class="grid grid-cols-1 md:grid-cols-3 gap-8">
            <!-- å·¦ä¾§ï¼šè¾“å…¥ä¸æ§åˆ¶ -->
            <div class="md:col-span-1 bg-white p-6 rounded-2xl shadow-lg">
                <h2 class="text-2xl font-semibold mb-4 border-b pb-3">ç¬¬ä¸€æ­¥ï¼šé…ç½®ä¸ä¸Šä¼ </h2>
                <div class="space-y-4">
                     <div>
                        <label for="product-pdf" class="block text-sm font-medium text-gray-700 mb-1">äº§å“åŸå§‹èµ„æ–™ (PDF)</label>
                        <input type="file" id="product-pdf" accept=".pdf" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer">
                        <div id="pdf-feedback" class="file-upload-feedback"></div>
                    </div>
                    <div>
                        <label for="supplemental-text" class="block text-sm font-medium text-gray-700 mb-1">è¡¥å……æ›´å¤šæ–‡æœ¬ä¿¡æ¯ (å¯é€‰)</label>
                        <textarea id="supplemental-text" rows="3" placeholder="è¯·è¾“å…¥è¡¥å……ä¿¡æ¯..." class="block w-full text-sm text-gray-500 rounded-lg border border-gray-300 p-2 focus:border-blue-400 focus:outline-none"></textarea>
                        <div id="supplemental-text-feedback" class="file-upload-feedback"></div>
                    </div>
                    <div>
                        <label for="gemini-model-select" class="block text-sm font-medium text-gray-700 mb-1">é€‰æ‹©Geminiæ¨¡å‹</label>
                        <select id="gemini-model-select" class="block w-full text-sm text-gray-700 rounded-lg border border-gray-300 p-2 focus:border-blue-400 focus:outline-none">
                            <option value="gemini-2.5-flash-preview-05-20" selected>gemini-2.5-flash-preview-05-20ï¼ˆé»˜è®¤æ¨èï¼‰</option>
                            <option value="gemini-2.5-pro-preview-06-05">gemini-2.5-pro-preview-06-05</option>
                            <option value="gemini-2.0-flash">gemini-2.0-flash</option>
                        </select>
                        <div id="gemini-model-feedback" class="file-upload-feedback"></div>
                    </div>
                </div>

                <div class="mt-6 pt-6 border-t">
                    <h3 class="text-lg font-semibold mb-3">ä¸Šä¼ è‡ªå®šä¹‰æ¨¡æ¿ (å¯é€‰)</h3>
                    <div class="space-y-4">
                        <div>
                            <label for="template-all-audience" class="block text-sm font-medium text-gray-700 mb-1">å…¨é‡äººç¾¤ (JSON)</label>
                            <input type="file" id="template-all-audience" accept=".json" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100 cursor-pointer">
                            <div id="template-all-audience-feedback" class="file-upload-feedback"></div>
                        </div>
                         <div>
                            <label for="template-high-score-audience" class="block text-sm font-medium text-gray-700 mb-1">[äººç¾¤]æ¨¡æ¿ (JSON)</label>
                            <input type="file" id="template-high-score-audience" accept=".json" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100 cursor-pointer">
                            <div id="template-high-score-audience-feedback" class="file-upload-feedback"></div>
                        </div>
                         <div>
                            <label for="template-scene-insight" class="block text-sm font-medium text-gray-700 mb-1">åœºæ™¯æ´å¯Ÿæ¨¡æ¿ (JSON)</label>
                            <input type="file" id="template-scene-insight" accept=".json" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100 cursor-pointer">
                            <div id="template-scene-insight-feedback" class="file-upload-feedback"></div>
                        </div>
                        <div>
                            <label for="custom-core-crowds" class="block text-sm font-medium text-gray-700 mb-1">è‡ªå®šä¹‰æ ¸å¿ƒäººç¾¤æ˜ç»† (Excel, å¯é€‰)</label>
                            <input type="file" id="custom-core-crowds" accept=".xlsx" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-yellow-50 file:text-yellow-700 hover:file:bg-yellow-100 cursor-pointer">
                            <div id="custom-core-crowds-feedback" class="file-upload-feedback"></div>
                        </div>
                    </div>
                </div>

                <div class="mt-8">
                    <button id="start-workflow-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition duration-300 disabled:bg-gray-400 flex items-center justify-center">
                        <span id="btn-text">ğŸš€ å¯åŠ¨å·¥ä½œæµ</span>
                    </button>
                </div>
            </div>

            <!-- å³ä¾§ï¼šçŠ¶æ€ä¸è¾“å‡º -->
            <div class="md:col-span-2 space-y-6">
                 <!-- çŠ¶æ€ç›‘æ§ -->
                <div class="bg-white p-6 rounded-2xl shadow-lg">
                    <h2 class="text-2xl font-semibold mb-4 border-b pb-3">ç¬¬äºŒæ­¥ï¼šå·¥ä½œæµç›‘æ§</h2>
                     <p class="text-xs text-gray-500 mb-3">è¯·æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…æ§åˆ¶å° (F12) æŸ¥çœ‹çœŸå®çš„APIè¯·æ±‚æ„é€ è¿‡ç¨‹ã€‚</p>
                    <div id="status-container" class="space-y-3">
                        <!-- çŠ¶æ€é¡¹å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>

                <!-- ç»“æœä¸‹è½½ -->
                <div id="results-container" class="bg-white p-6 rounded-2xl shadow-lg hidden">
                    <h2 class="text-2xl font-semibold mb-4 border-b pb-3 text-green-600">ğŸ‰ å·¥ä½œæµå®Œæˆï¼ä¸‹è½½æ‚¨çš„ç­–ç•¥æ–‡ä»¶</h2>
                    <div id="download-buttons" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- ä¸‹è½½æŒ‰é’®å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- é¢„è§ˆ Modal -->
    <div id="preview-modal" class="modal-overlay hidden">
        <div class="modal-content w-full md:w-2/3 lg:w-1/2">
            <div class="flex justify-between items-center border-b pb-2 mb-4">
                <h3 id="modal-title" class="text-xl font-bold">æ–‡ä»¶é¢„è§ˆ</h3>
                <button id="close-modal-btn" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
            </div>
            <div id="modal-body" class="prose max-w-none"></div>
        </div>
    </div>


    <script>
        // --- GLOBAL STATE & CONFIG ---
        let GEMINI_MODEL = "gemini-2.5-flash-preview-05-20";

        let workflowState = {};
        let uploadedPdfFile = null;
        let supplementalText = '';
        let isPaused = false;

        // --- FILE CACHE: Storing user-provided templates and data ---
        const fileCache = {
            'å…¨é‡äººç¾¤.json': [], // åˆå§‹åŒ–ä¸ºç©ºæ•°ç»„ï¼Œå°†åœ¨åˆå§‹åŒ–æ—¶åŠ è½½å®Œæ•´æ•°æ®
            '[äººç¾¤]æ¨¡æ¿.json': {"matchedCrowds":[{"groupName":"","typeOption":"","industryOption":"","groupDesc":"","coverNum":0,"äººç¾¤ç±»å‹":"","score":0,"reasoning":""}]},
            '[åœºæ™¯æ´å¯Ÿ]æ¨¡æ¿.json': {"æ•´åˆäººç¾¤åœºæ™¯æ´å¯Ÿ":[{"åŸå§‹ä¼˜è´¨äººç¾¤":{"groupName":"","typeOption":"","industryOption":"","groupDesc":"","coverNum":0,"äººç¾¤ç±»å‹":"","score":0,"reasoning":""},"æ‹“å±•å…¸å‹äººç¾¤":[{"å…¸å‹äººç¾¤åç§°":"","å…¸å‹äººç¾¤ç”»åƒæè¿°":"","éœ€æ±‚ç—›ç‚¹":"","åŒ¹é…äº§å“å–ç‚¹":"","ç²¾ç»†åŒ–ä½¿ç”¨åœºæ™¯":[{"åœºæ™¯åç§°":"","åœºæ™¯æè¿°":"","å°çº¢ä¹¦æ ¸å¿ƒè¯æœ¯":""}]}]}]}
        };

        // åŠ è½½å®Œæ•´çš„äººç¾¤æ•°æ®
        async function loadFullAudienceData() {
            try {
                const response = await fetch('/api/audience');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                fileCache['å…¨é‡äººç¾¤.json'] = data;
                templateAllAudienceFeedback.textContent = `å·²åŠ è½½: å…¨é‡äººç¾¤.json (${data.length}ä¸ªäººç¾¤)`;
                templateAllAudienceFeedback.style.color = '#16a34a';
                console.log(`æˆåŠŸåŠ è½½å…¨é‡äººç¾¤æ•°æ®ï¼Œå…±${data.length}æ¡è®°å½•`);
            } catch (error) {
                console.error('åŠ è½½å…¨é‡äººç¾¤æ•°æ®å¤±è´¥:', error);
                // ä½¿ç”¨é»˜è®¤çš„ç¤ºä¾‹æ•°æ®
                fileCache['å…¨é‡äººç¾¤.json'] = [{"groupName":"é¢œé€‰å¯»é¦™äºº","typeOption":"è¡Œä¸šç‰¹è‰²","industryOption":"æ—¥åŒ–å®¶æ¸…","groupDesc":"åœ¨ã€é¦™æ°´é¦™è–°è¡Œä¸šã€‘ä¸‹æœ‰ã€å¸¸è§„çº¸å·¾ç±»ç›®ã€‘é˜…è¯»/æœç´¢è¡Œä¸ºä»¥åŠå¯¹å…³é”®è¯ã€é¦™å‘³çº¸å·¾ã€è”åçº¸å·¾ã€çº¸å·¾è®¾è®¡ã€‘ç­‰æœ‰é˜…è¯»/æœç´¢è¡Œä¸ºçš„äºº","coverNum":26241156,"äººç¾¤ç±»å‹":"è¡Œä¸šäººç¾¤"},{"groupName":"ã€å®ç›Ÿåª’ä½“é›†å›¢ã€‘æ—¶å°šé…é¥°-ä¸­é«˜æ¶ˆ","typeOption":"è¡Œä¸šç‰¹è‰²","industryOption":"å¥¢ä¾ˆå“","groupDesc":"è¿‘30å¤©æ—¶å°š-é…é¥°æœç´¢/é˜…è¯»å…´è¶£ç±»ç›®ï¼Œé˜…è¯»â‰¥1âˆªæœç´¢/æœåäº’åŠ¨/æœåé˜…è¯»â‰¥1ï¼Œä¸­/é«˜æ¶ˆè´¹æ°´å¹³","coverNum":87012066,"äººç¾¤ç±»å‹":"è¡Œä¸šäººç¾¤"}];
                templateAllAudienceFeedback.textContent = 'ä½¿ç”¨é»˜è®¤ç¤ºä¾‹æ•°æ® (2ä¸ªäººç¾¤)';
                templateAllAudienceFeedback.style.color = '#ef4444';
            }
        }

        // --- WORKFLOW NODES DEFINITION ---
        const workflowNodes = [
            { id: 1, name: 'äº§å“ä¿¡æ¯æ·±åº¦æå–', func: runNode1, useAI: true },
            { id: 3, name: 'ç”Ÿæˆå°çº¢ä¹¦å†…å®¹ä¸KOLç­–ç•¥', func: runNode3, useAI: true },
            { id: 4, name: 'äººç¾¤åº“æ™ºèƒ½åŒ¹é…ä¸æ’åº', func: runNode4, useAI: false },
            { id: 5, name: 'AIé©±åŠ¨çš„æ–°äººç¾¤æ¢ç´¢ä¸æ•´åˆ', func: runNode5, useAI: true },
            { id: 6, name: 'ç­›é€‰å¹¶è¾“å‡ºTop30æ ¸å¿ƒäººç¾¤', func: runNode6, useAI: false },
            { id: 7, name: 'äººç¾¤åœºæ™¯æ´å¯Ÿä¸å°çº¢ä¹¦è¯æœ¯ç”Ÿæˆ', func: runNode7, useAI: true },
            { id: 8, name: 'ç”Ÿæˆå¯äº¤ä»˜çš„Excelè¥é”€åœºæ™¯è¡¨', func: runNode8, useAI: false },
        ];
        
        // --- UI ELEMENTS ---
        const startBtn = document.getElementById('start-workflow-btn');
        const btnText = document.getElementById('btn-text');
        const statusContainer = document.getElementById('status-container');
        const resultsContainer = document.getElementById('results-container');
        const downloadButtonsContainer = document.getElementById('download-buttons');
        const pdfFileInput = document.getElementById('product-pdf');
        const supplementalTextInput = document.getElementById('supplemental-text');
        const pdfFeedback = document.getElementById('pdf-feedback');
        const supplementalTextFeedback = document.getElementById('supplemental-text-feedback');
        const templateAllAudienceInput = document.getElementById('template-all-audience');
        const templateHighScoreAudienceInput = document.getElementById('template-high-score-audience');
        const templateSceneInsightInput = document.getElementById('template-scene-insight');
        const templateAllAudienceFeedback = document.getElementById('template-all-audience-feedback');
        const templateHighScoreAudienceFeedback = document.getElementById('template-high-score-audience-feedback');
        const templateSceneInsightFeedback = document.getElementById('template-scene-insight-feedback');
        const previewModal = document.getElementById('preview-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const closeModalBtn = document.getElementById('close-modal-btn');
        
        // æ·»åŠ æš‚åœ/æ¢å¤æŒ‰é’®
        const pauseBtn = document.createElement('button');
        pauseBtn.id = 'pause-workflow-btn';
        pauseBtn.className = 'w-full bg-gray-400 text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-500 transition duration-300 mt-2';
        pauseBtn.textContent = 'æš‚åœ';
        startBtn.parentNode.appendChild(pauseBtn);

        pauseBtn.addEventListener('click', () => {
            isPaused = !isPaused;
            pauseBtn.textContent = isPaused ? 'æ¢å¤' : 'æš‚åœ';
        });

        // --- EVENT LISTENERS ---
        pdfFileInput.addEventListener('change', (e) => handleFileUpload(e, 'pdf'));
        supplementalTextInput.addEventListener('input', (e) => {
            supplementalText = e.target.value;
            if (supplementalText.trim().length > 0) {
                supplementalTextFeedback.textContent = `å·²è¾“å…¥è¡¥å……ä¿¡æ¯ (${supplementalText.length} å­—)`;
                supplementalTextFeedback.style.color = '#16a34a';
            } else {
                supplementalTextFeedback.textContent = '';
            }
        });
        templateAllAudienceInput.addEventListener('change', (e) => handleTemplateUpload(e, 'å…¨é‡äººç¾¤.json', templateAllAudienceFeedback));
        templateHighScoreAudienceInput.addEventListener('change', (e) => handleTemplateUpload(e, '[äººç¾¤]æ¨¡æ¿.json', templateHighScoreAudienceFeedback));
        templateSceneInsightInput.addEventListener('change', (e) => handleTemplateUpload(e, '[åœºæ™¯æ´å¯Ÿ]æ¨¡æ¿.json', templateSceneInsightFeedback));
        startBtn.addEventListener('click', startWorkflow);
        closeModalBtn.addEventListener('click', () => previewModal.classList.add('hidden'));
        previewModal.addEventListener('click', (e) => {
            if (e.target === previewModal) previewModal.classList.add('hidden');
        });

        const geminiModelSelect = document.getElementById('gemini-model-select');
        const geminiModelFeedback = document.getElementById('gemini-model-feedback');

        geminiModelSelect.addEventListener('change', (e) => {
            GEMINI_MODEL = e.target.value;
            geminiModelFeedback.textContent = `å·²é€‰æ‹©æ¨¡å‹ï¼š${GEMINI_MODEL}`;
            geminiModelFeedback.style.color = '#16a34a';
        });

        // --- CORE FUNCTIONS ---

        function handleFileUpload(event, type) {
            const file = event.target.files[0];
            if (!file) return;
            const feedbackEl = type === 'pdf' ? pdfFeedback : supplementalTextFeedback;
            feedbackEl.textContent = `å·²é€‰æ‹©: ${file.name}`;
            feedbackEl.style.color = '#16a34a';

            if (type === 'pdf') {
                uploadedPdfFile = file;
            }
        }

        function handleTemplateUpload(event, cacheKey, feedbackEl) {
             const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const parsedJson = JSON.parse(e.target.result);
                    fileCache[cacheKey] = parsedJson;
                    feedbackEl.textContent = `å·²è¦†ç›–: ${file.name}`;
                    feedbackEl.style.color = '#16a34a';
                    console.log(`æ¨¡æ¿ ${cacheKey} å·²è¢«æ–‡ä»¶ ${file.name} æ›´æ–°ã€‚`);
                } catch (error) {
                    feedbackEl.textContent = error.message || 'JSONæ–‡ä»¶æ ¼å¼é”™è¯¯!';
                    feedbackEl.style.color = '#ef4444';
                }
            };
            reader.readAsText(file);
        }
        
        function initStatusUI() {
            statusContainer.innerHTML = '';
            workflowNodes.forEach(node => {
                const statusElement = document.createElement('div');
                statusElement.id = `status-node-${node.id}`;
                statusElement.className = 'status-item pending p-3 border-l-4 border-gray-300 bg-gray-50 rounded-lg';
                statusElement.innerHTML = `<div><span class="font-semibold">${node.name}</span>: <span class="status-text">å¾…å®š</span></div><div class="downloads"></div>`;
                statusContainer.appendChild(statusElement);
            });
        }
        
        function updateStatus(nodeId, statusText, type, errorMsg = null, rawError = null, retryHandler = null) {
            const nodeElement = document.getElementById(`status-node-${nodeId}`);
            if (nodeElement) {
                const statusTextEl = nodeElement.querySelector('.status-text');
                if(type === 'processing' && workflowNodes.find(n => n.id === nodeId).useAI) {
                     statusTextEl.innerHTML = `<span class="spinner"></span> æ­£åœ¨è°ƒç”¨Gemini API...`;
                } else {
                     statusTextEl.textContent = statusText;
                }
                nodeElement.classList.remove('pending', 'processing', 'completed', 'error');
                nodeElement.classList.add(type);
                if (type === 'completed') {
                    addIntermediateDownloadButton(nodeId, nodeElement);
                }
                // é”™è¯¯ä¿¡æ¯å±•ç¤º
                let errorDiv = nodeElement.querySelector('.error-message');
                if (!errorDiv) {
                    errorDiv = document.createElement('div');
                    errorDiv.className = 'error-message text-red-500 text-xs mt-1';
                    nodeElement.appendChild(errorDiv);
                }
                errorDiv.textContent = errorMsg && type === 'error' ? errorMsg : '';
                // åŸå§‹é”™è¯¯å†…å®¹å±•ç¤º
                let rawDiv = nodeElement.querySelector('.raw-error-message');
                if (!rawDiv) {
                    rawDiv = document.createElement('div');
                    rawDiv.className = 'raw-error-message text-gray-400 text-xs mt-1';
                    nodeElement.appendChild(rawDiv);
                }
                rawDiv.textContent = rawError && type === 'error' ? `åŸå§‹å“åº”: ${rawError}` : '';
                // é‡è¯•æŒ‰é’®
                let retryBtn = nodeElement.querySelector('.retry-btn');
                if (type === 'error' && retryHandler && workflowNodes.find(n => n.id === nodeId).useAI) {
                    if (!retryBtn) {
                        retryBtn = document.createElement('button');
                        retryBtn.className = 'retry-btn bg-blue-100 text-blue-700 px-2 py-1 rounded ml-2 text-xs';
                        retryBtn.textContent = 'é‡è¯•';
                        retryBtn.onclick = retryHandler;
                        errorDiv.appendChild(retryBtn);
                    }
                } else if (retryBtn) {
                    retryBtn.remove();
                }
            }
        }
        
        async function startWorkflow() {
            startBtn.disabled = true;
            btnText.textContent = 'å·¥ä½œæµè¿è¡Œä¸­...';
            resultsContainer.classList.add('hidden');
            downloadButtonsContainer.innerHTML = '';
            isPaused = false;
            pauseBtn.textContent = 'æš‚åœ';
            
            initStatusUI();
            initializeDefaultFileNames(); 

            // åˆ¤æ–­ä¾èµ–ï¼šåªæœ‰åœ¨äº§å“å–ç‚¹å’Œå†…å®¹åˆ›ä½œç­–ç•¥éƒ½å·²ç”Ÿæˆæ—¶ï¼Œæ‰å…è®¸ä»…æ‰§è¡Œç¬¬ä¸ƒæ­¥
            const canRunOnlyNode7 = workflowState.äº§å“å–ç‚¹ && workflowState.å†…å®¹åˆ›ä½œç­–ç•¥åŠå®¡ç¨¿è§„åˆ™;
            if (fileCache['è‡ªå®šä¹‰æ ¸å¿ƒäººç¾¤.xlsx'] && fileCache['è‡ªå®šä¹‰æ ¸å¿ƒäººç¾¤.xlsx'].length > 0) {
                if (!canRunOnlyNode7) {
                    alert('è¯·å…ˆå®Œæ•´æ‰§è¡Œä¸€æ¬¡å·¥ä½œæµï¼Œç”Ÿæˆäº§å“å–ç‚¹å’Œå†…å®¹åˆ›ä½œç­–ç•¥åï¼Œæ‰èƒ½ä»…ç”¨è‡ªå®šä¹‰æ ¸å¿ƒäººç¾¤æ˜ç»†æ‰§è¡Œç¬¬ä¸ƒæ­¥ï¼');
                    startBtn.disabled = false;
                    btnText.textContent = 'ğŸš€ å¯åŠ¨å·¥ä½œæµ';
                    return;
                }
                // ä»…æ‰§è¡Œç¬¬ä¸ƒæ­¥ï¼Œå¤ç”¨å‰é¢å·²ç”Ÿæˆçš„äº§å“å–ç‚¹å’Œå†…å®¹åˆ›ä½œç­–ç•¥
                const prevState = { ...workflowState };
                workflowState = {
                    ...prevState,
                    äººç¾¤é«˜åˆ†: { raw: fileCache['è‡ªå®šä¹‰æ ¸å¿ƒäººç¾¤.xlsx'] }
                };
                updateStatus(7, 'å¤„ç†ä¸­...', 'processing');
                try {
                    workflowState = await runNode7(workflowState);
                    updateStatus(7, 'å®Œæˆ', 'completed');
                    displayResults(workflowState.finalDownloads);
                } catch (error) {
                    updateStatus(7, `é”™è¯¯: ${error.message}`, 'error', error.message);
                }
                startBtn.disabled = false;
                btnText.textContent = 'ğŸš€ é‡æ–°è¿è¡Œå·¥ä½œæµ';
                return;
            }
            // å¦åˆ™å…¨æµç¨‹
            workflowState = {};
            for (const node of workflowNodes) {
                // æ£€æŸ¥æš‚åœ
                while (isPaused) {
                    await new Promise(res => setTimeout(res, 200));
                }
                updateStatus(node.id, 'å¤„ç†ä¸­...', 'processing');
                try {
                    await new Promise(res => setTimeout(res, 200)); 
                    workflowState = await node.func(workflowState);
                    updateStatus(node.id, 'å®Œæˆ', 'completed');
                } catch (error) {
                    console.error(`èŠ‚ç‚¹ ${node.name} å¤±è´¥:`, error);
                    updateStatus(node.id, `é”™è¯¯: ${error.message}`, 'error', error.message);
                    startBtn.disabled = false;
                    btnText.textContent = 'ğŸš€ å¯åŠ¨å·¥ä½œæµ';
                    // ä¸å†ç»§ç»­åç»­èŠ‚ç‚¹
                    return;
                }
            }
            displayResults(workflowState.finalDownloads);
            startBtn.disabled = false;
            btnText.textContent = 'ğŸš€ é‡æ–°è¿è¡Œå·¥ä½œæµ';
        }

        function displayResults(downloads) {
            resultsContainer.classList.remove('hidden');
            downloads.forEach(file => {
                const buttonContainer = document.createElement('div');
                buttonContainer.className = 'flex flex-col space-y-2';
                const downloadButton = document.createElement('button');
                downloadButton.textContent = `ä¸‹è½½ ${file.name}`;
                downloadButton.className = 'w-full bg-green-500 text-white font-semibold py-2 px-3 rounded-lg hover:bg-green-600 transition duration-300 text-sm';
                downloadButton.onclick = () => downloadFile(file.content, file.name, file.type);
                const previewButton = document.createElement('button');
                previewButton.textContent = 'é¢„è§ˆ';
                previewButton.className = 'w-full bg-gray-200 text-gray-700 font-semibold py-1 px-3 rounded-lg hover:bg-gray-300 transition duration-300 text-xs';
                previewButton.onclick = () => showPreview(file);
                buttonContainer.appendChild(downloadButton);
                buttonContainer.appendChild(previewButton);
                downloadButtonsContainer.appendChild(buttonContainer);
            });
        }
        
        function showPreview(file) {
            modalTitle.textContent = `é¢„è§ˆ: ${file.name}`;
            try {
                if (file.name.endsWith('.md')) {
                    modalBody.innerHTML = marked.parse(jsonToMarkdown(file.content));
                } else if (file.name.endsWith('.xlsx')) {
                    const worksheet = XLSX.utils.json_to_sheet(file.content.data);
                    const html = XLSX.utils.sheet_to_html(worksheet);
                    modalBody.innerHTML = `<div class="overflow-x-auto">${html}</div>`;
                } else {
                     modalBody.innerHTML = `<pre class="whitespace-pre-wrap"><code>${JSON.stringify(file.content, null, 2)}</code></pre>`;
                }
            } catch (error) {
                modalBody.innerHTML = `<p class="text-red-500">æ— æ³•ç”Ÿæˆé¢„è§ˆã€‚</p><pre>${error}</pre>`;
            }
            previewModal.classList.remove('hidden');
        }

        function jsonToMarkdown(json, level = 1, noEmptyLine = false) {
            let md = '';
            const lineBreak = '\n';
            const emptyLine = noEmptyLine ? '' : '\n';
            if (level === 1) {
                md += `# ${json.title || 'æ•°æ®æŠ¥å‘Š'}${lineBreak}`;
                if (!json.data) return md;
                return md + jsonToMarkdown(json.data, level + 1, noEmptyLine);
            }
            if (Array.isArray(json)) {
                json.forEach((item, idx) => {
                    md += `##${'#'.repeat(level-1)} ${idx}${lineBreak}`;
                    md += jsonToMarkdown(item, level + 1, noEmptyLine);
                    md += `---${lineBreak}`;
                });
            } else if (typeof json === 'object' && json !== null) {
                Object.entries(json).forEach(([key, value]) => {
                    md += `**${key}**:`;
                    if (typeof value === 'object' && value !== null) {
                        md += lineBreak + jsonToMarkdown(value, level + 1, noEmptyLine);
                    } else {
                        md += ` ${value}${lineBreak}`;
                    }
                });
            } else {
                md += `${json}${lineBreak}`;
            }
            return md;
        }

        function downloadFile(content, fileName, type) {
            let blob;
            try {
                if (type === 'excel') {
                     const ws = XLSX.utils.json_to_sheet(content.data);
                     const wb = XLSX.utils.book_new();
                     XLSX.utils.book_append_sheet(wb, ws, 'Sheet1');
                     const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
                     blob = new Blob([wbout], {type: "application/octet-stream"});
                } else if (type === 'markdown') {
                    // èŠ‚ç‚¹3çš„ä¸¤ä¸ªmdæ–‡ä»¶æœ‰æ¢è¡Œä½†æ— ç©ºè¡Œ
                    const noEmptyLine = fileName === 'KOLåª’ä»‹ç­–ç•¥.md' || fileName === 'å†…å®¹åˆ›ä½œç­–ç•¥ä»¥åŠå®¡ç¨¿è§„åˆ™.md';
                    blob = new Blob([jsonToMarkdown(content, 1, noEmptyLine)], { type: 'text/markdown;charset=utf-8' });
                } else {
                    blob = new Blob([JSON.stringify(content, null, 2)], { type: 'application/json;charset=utf-8' });
                }
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = fileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } catch (error) {
                console.error("ä¸‹è½½æ–‡ä»¶æ—¶å‡ºé”™:", error);
                alert("åˆ›å»ºä¸‹è½½æ–‡ä»¶å¤±è´¥ï¼");
            }
        }

        // è·å–äº§å“åç§°çš„å‡½æ•°
        function getProductName() {
            if (uploadedPdfFile) {
                // ä»PDFæ–‡ä»¶åä¸­æå–äº§å“åç§°
                const fileName = uploadedPdfFile.name;
                // ç§»é™¤æ–‡ä»¶æ‰©å±•å
                const nameWithoutExt = fileName.replace(/\.(pdf|PDF)$/, '');
                // ç§»é™¤å¸¸è§çš„æ–‡ä»¶å‰ç¼€å’Œåç¼€ï¼Œä¿ç•™æ ¸å¿ƒäº§å“åç§°
                const cleanName = nameWithoutExt
                    .replace(/^[0-9\s\-_]+/, '') // ç§»é™¤å¼€å¤´çš„æ•°å­—ã€ç©ºæ ¼ã€è¿å­—ç¬¦ã€ä¸‹åˆ’çº¿
                    .replace(/[0-9\s\-_]+$/, '') // ç§»é™¤ç»“å°¾çš„æ•°å­—ã€ç©ºæ ¼ã€è¿å­—ç¬¦ã€ä¸‹åˆ’çº¿
                    .replace(/[^\u4e00-\u9fa5a-zA-Z0-9]/g, '') // åªä¿ç•™ä¸­æ–‡ã€è‹±æ–‡ã€æ•°å­—
                    .trim();
                
                // å¦‚æœæ¸…ç†åçš„åç§°ä¸ä¸ºç©ºï¼Œä½¿ç”¨å®ƒ
                if (cleanName && cleanName.length > 0) {
                    // é™åˆ¶é•¿åº¦ï¼Œé¿å…æ–‡ä»¶åè¿‡é•¿
                    return cleanName.length > 15 ? cleanName.substring(0, 15) : cleanName;
                }
                
                // å¦‚æœæ¸…ç†åä¸ºç©ºï¼Œä½¿ç”¨åŸå§‹æ–‡ä»¶åï¼ˆå»é™¤æ‰©å±•åï¼‰
                return nameWithoutExt.length > 15 ? nameWithoutExt.substring(0, 15) : nameWithoutExt;
            }
            
            // å¦‚æœæ²¡æœ‰PDFæ–‡ä»¶ï¼Œä½¿ç”¨é»˜è®¤åç§°
            return 'äº§å“';
        }

        const nodeOutputMapping = {
            1: [{ key: 'äº§å“å–ç‚¹', fileName: 'äº§å“å–ç‚¹.json', type: 'json' }],
            3: [ 
                { key: 'KOLåª’ä»‹ç­–ç•¥', fileName: 'KOLåª’ä»‹ç­–ç•¥.md', type: 'markdown' },
                { key: 'å†…å®¹åˆ›ä½œç­–ç•¥åŠå®¡ç¨¿è§„åˆ™', fileName: 'å†…å®¹åˆ›ä½œç­–ç•¥ä»¥åŠå®¡ç¨¿è§„åˆ™.md', type: 'markdown' }
            ],
            4: [
                { key: 'allResultsExcel', fileName: 'å…¨éƒ¨æ‰“åˆ†äººç¾¤æ˜ç»†.xlsx', type: 'excel' }
            ],
            5: [
                { key: 'finalMergedExcel', fileName: 'æœ€ç»ˆåˆå¹¶äººç¾¤æ˜ç»†.xlsx', type: 'excel' }
            ],
            6: [
                { key: 'top30Excel', fileName: 'Top30æ ¸å¿ƒäººç¾¤æ˜ç»†.xlsx', type: 'excel' }
            ],
            7: [{ key: 'åœºæ™¯æ´å¯Ÿ', fileName: '[åœºæ™¯æ´å¯Ÿ].xlsx', type: 'excel' }]
        };

        function addIntermediateDownloadButton(nodeId, parentElement) {
            const downloadsContainer = parentElement.querySelector('.downloads');
            if (!downloadsContainer) return;

            downloadsContainer.innerHTML = ''; // Clear previous buttons if any

            const mappings = nodeOutputMapping[nodeId];
            if (!mappings) return;

            // è·å–äº§å“åç§°ä½œä¸ºå‰ç¼€
            const productName = getProductName();
            const prefix = `[${productName}]`;

            mappings.forEach(mapping => {
                const downloadBtn = document.createElement('button');
                downloadBtn.className = 'download-icon p-1 rounded-full hover:bg-gray-200';
                downloadBtn.title = `ä¸‹è½½ ${prefix}${mapping.fileName}`;
                downloadBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>`;
                downloadBtn.onclick = () => {
                    const content = workflowState[mapping.key];
                    if(content) {
                        downloadFile(content, `${prefix}${mapping.fileName}`, mapping.type);
                    } else {
                        alert(`æ— æ³•ä¸‹è½½ï¼šèŠ‚ç‚¹ ${nodeId} çš„è¾“å‡ºæ•°æ®ä¸å­˜åœ¨ã€‚`);
                    }
                };
                downloadsContainer.appendChild(downloadBtn);
            });
        }


        // --- REAL API CALL FUNCTION ---
        async function callGeminiAPI(prompt, responseSchema = null, schemaType = null, retryCount = 0) {
            // é€šè¿‡åç«¯APIä»£ç†è°ƒç”¨
            const model = GEMINI_MODEL;
            
            // æ ¹æ®ä¸åŒçš„è°ƒç”¨åœºæ™¯å®šä¹‰å…·ä½“çš„JSON schema
            let schema = null;
            if (responseSchema) {
                if (schemaType === 'crowd') {
                    // ä½¿ç”¨[äººç¾¤]æ¨¡æ¿.jsonç”Ÿæˆschema
                    const crowdTemplate = fileCache['[äººç¾¤]æ¨¡æ¿.json'];
                    if (crowdTemplate) {
                        schema = generateJsonSchemaFromExample(crowdTemplate);
                    }
                } else if (schemaType === 'scene') {
                    // ä½¿ç”¨[åœºæ™¯æ´å¯Ÿ]æ¨¡æ¿.jsonç”Ÿæˆschema
                    const sceneTemplate = fileCache['[åœºæ™¯æ´å¯Ÿ]æ¨¡æ¿.json'];
                    if (sceneTemplate) {
                        schema = generateJsonSchemaFromExample(sceneTemplate);
                    }
                } else {
                    schema = null;
                }
            }
            // ä¼˜åŒ–promptç»“å°¾
            let finalPrompt = prompt.trim();
            if (!finalPrompt.match(/åªè¾“å‡ºçº¯JSON/)) {
                finalPrompt += '\n\nã€æ ¼å¼è¦æ±‚ã€‘åªè¾“å‡ºçº¯JSONï¼Œä¸è¦æœ‰ä»»ä½•markdownä»£ç å—æ ‡è®°ï¼ˆå¦‚```jsonï¼‰ã€‚';
            }
            console.log('[Geminiè°ƒè¯•] å³å°†è¯·æ±‚åç«¯API:', {
                url: window.location.origin + '/api/gemini',
                model,
                hasSchema: !!schema,
                schemaType: schemaType || 'none',
                prompt: finalPrompt.length > 200 ? finalPrompt.slice(0, 200) + '...ï¼ˆå·²æˆªæ–­ï¼‰' : finalPrompt
            });
            try {
                const resp = await fetch('/api/gemini', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        prompt: finalPrompt, 
                        model, 
                        responseSchema: schema,
                        schemaType: schemaType
                    })
                });
                const text = await resp.text();
                let data;
                try {
                    data = JSON.parse(text);
                } catch (e) {
                    console.error('[Geminiè°ƒè¯•] å“åº”éJSON:', text);
                    throw new Error('åç«¯è¿”å›éJSONæ ¼å¼: ' + text);
                }
                console.log('[Geminiè°ƒè¯•] åç«¯å“åº”:', data);
                if (!resp.ok) {
                    throw new Error(data.error || 'åç«¯Gemini APIè¯·æ±‚å¤±è´¥');
                }
                // --- å…œåº•æ¸…æ´— ---
                let result = data.result;
                if (typeof result === 'string') {
                    // å»é™¤markdownä»£ç å—
                    result = result.replace(/```json[\s\S]*?```/g, m => m.replace(/```json|```/g, '').trim());
                    result = result.replace(/```[\s\S]*?```/g, m => m.replace(/```/g, '').trim());
                    
                    // å°è¯•å¤šç§æ–¹å¼æå–JSON
                    let jsonMatch = null;
                    
                    // æ–¹æ³•1ï¼šå°è¯•æå–ç¬¬ä¸€ä¸ªåˆæ³•JSONå¯¹è±¡æˆ–æ•°ç»„
                    jsonMatch = result.match(/({[\s\S]*}|\[[\s\S]*\])/);
                    if (jsonMatch) {
                        result = jsonMatch[0];
                    }
                    
                    // æ–¹æ³•2ï¼šå¦‚æœæ–¹æ³•1å¤±è´¥ï¼Œå°è¯•ä¿®å¤å¸¸è§çš„JSONé”™è¯¯
                    if (!jsonMatch) {
                        // ä¿®å¤å¸¸è§çš„JSONæ ¼å¼é—®é¢˜
                        result = result
                            .replace(/,\s*}/g, '}')  // ç§»é™¤å¯¹è±¡æœ«å°¾å¤šä½™çš„é€—å·
                            .replace(/,\s*]/g, ']')  // ç§»é™¤æ•°ç»„æœ«å°¾å¤šä½™çš„é€—å·
                            .replace(/}\s*,\s*}/g, '}}')  // ä¿®å¤åµŒå¥—å¯¹è±¡
                            .replace(/]\s*,\s*]/g, ']]')  // ä¿®å¤åµŒå¥—æ•°ç»„
                            .replace(/}\s*,\s*]/g, '}]')  // ä¿®å¤å¯¹è±¡æ•°ç»„æ··åˆ
                            .replace(/]\s*,\s*}/g, ']}'); // ä¿®å¤æ•°ç»„å¯¹è±¡æ··åˆ
                        
                        // æ–°å¢ï¼šä¸“é—¨ä¿®å¤æ•°ç»„å…ƒç´ é—´ç¼ºå°‘é€—å·çš„é—®é¢˜
                        // è¿™æ˜¯é’ˆå¯¹"Expected ',' or ']' after array element"é”™è¯¯çš„ä¸“é—¨ä¿®å¤
                        result = result
                            // ä¿®å¤æ•°ç»„ä¸­çš„å¯¹è±¡ä¹‹é—´ç¼ºå°‘é€—å·
                            .replace(/}\s*}/g, '},}')  // å¯¹è±¡åç›´æ¥è·Ÿå¯¹è±¡ï¼Œæ·»åŠ é€—å·
                            .replace(/}\s*\[/g, '},[')  // å¯¹è±¡åç›´æ¥è·Ÿæ•°ç»„ï¼Œæ·»åŠ é€—å·
                            .replace(/]\s*}/g, '],}')  // æ•°ç»„åç›´æ¥è·Ÿå¯¹è±¡ï¼Œæ·»åŠ é€—å·
                            .replace(/]\s*\[/g, '],[')  // æ•°ç»„åç›´æ¥è·Ÿæ•°ç»„ï¼Œæ·»åŠ é€—å·
                            // ä¿®å¤å­—ç¬¦ä¸²åç¼ºå°‘é€—å·
                            .replace(/"\s*"/g, '","')  // å­—ç¬¦ä¸²åç›´æ¥è·Ÿå­—ç¬¦ä¸²ï¼Œæ·»åŠ é€—å·
                            .replace(/"\s*}/g, '",}')  // å­—ç¬¦ä¸²åç›´æ¥è·Ÿå¯¹è±¡ç»“æŸï¼Œæ·»åŠ é€—å·
                            .replace(/"\s*]/g, '",]')  // å­—ç¬¦ä¸²åç›´æ¥è·Ÿæ•°ç»„ç»“æŸï¼Œæ·»åŠ é€—å·
                            .replace(/"\s*\{/g, '",{')  // å­—ç¬¦ä¸²åç›´æ¥è·Ÿå¯¹è±¡å¼€å§‹ï¼Œæ·»åŠ é€—å·
                            .replace(/"\s*\[/g, '",[')  // å­—ç¬¦ä¸²åç›´æ¥è·Ÿæ•°ç»„å¼€å§‹ï¼Œæ·»åŠ é€—å·
                            // ä¿®å¤æ•°å­—åç¼ºå°‘é€—å·
                            .replace(/(\d+)\s*"/g, '$1,"')  // æ•°å­—åç›´æ¥è·Ÿå­—ç¬¦ä¸²ï¼Œæ·»åŠ é€—å·
                            .replace(/(\d+)\s*}/g, '$1,}')  // æ•°å­—åç›´æ¥è·Ÿå¯¹è±¡ç»“æŸï¼Œæ·»åŠ é€—å·
                            .replace(/(\d+)\s*]/g, '$1,]')  // æ•°å­—åç›´æ¥è·Ÿæ•°ç»„ç»“æŸï¼Œæ·»åŠ é€—å·
                            .replace(/(\d+)\s*\{/g, '$1,{')  // æ•°å­—åç›´æ¥è·Ÿå¯¹è±¡å¼€å§‹ï¼Œæ·»åŠ é€—å·
                            .replace(/(\d+)\s*\[/g, '$1,[')  // æ•°å­—åç›´æ¥è·Ÿæ•°ç»„å¼€å§‹ï¼Œæ·»åŠ é€—å·
                            // ä¿®å¤å¸ƒå°”å€¼å’Œnullåç¼ºå°‘é€—å·
                            .replace(/(true|false|null)\s*"/g, '$1,"')  // å¸ƒå°”å€¼/nullåç›´æ¥è·Ÿå­—ç¬¦ä¸²ï¼Œæ·»åŠ é€—å·
                            .replace(/(true|false|null)\s*}/g, '$1,}')  // å¸ƒå°”å€¼/nullåç›´æ¥è·Ÿå¯¹è±¡ç»“æŸï¼Œæ·»åŠ é€—å·
                            .replace(/(true|false|null)\s*]/g, '$1,]')  // å¸ƒå°”å€¼/nullåç›´æ¥è·Ÿæ•°ç»„ç»“æŸï¼Œæ·»åŠ é€—å·
                            .replace(/(true|false|null)\s*\{/g, '$1,{')  // å¸ƒå°”å€¼/nullåç›´æ¥è·Ÿå¯¹è±¡å¼€å§‹ï¼Œæ·»åŠ é€—å·
                            .replace(/(true|false|null)\s*\[/g, '$1,['); // å¸ƒå°”å€¼/nullåç›´æ¥è·Ÿæ•°ç»„å¼€å§‹ï¼Œæ·»åŠ é€—å·
                        
                        // å†æ¬¡å°è¯•åŒ¹é…
                        jsonMatch = result.match(/({[\s\S]*}|\[[\s\S]*\])/);
                        if (jsonMatch) {
                            result = jsonMatch[0];
                        }
                    }
                    
                    try {
                        result = JSON.parse(result);
                    } catch (e) {
                        console.warn('[Geminiè°ƒè¯•] JSONè§£æå¤±è´¥ï¼Œå°è¯•æ‰‹åŠ¨ä¿®å¤:', e.message);
                        
                        // æ–¹æ³•3ï¼šæ‰‹åŠ¨ä¿®å¤å¸¸è§çš„JSONé”™è¯¯
                        try {
                            // ä¿®å¤å¼•å·é—®é¢˜
                            result = result
                                .replace(/([^\\])"/g, '$1\\"')  // è½¬ä¹‰æœªè½¬ä¹‰çš„å¼•å·
                                .replace(/\\"/g, '"')  // ä¿®å¤è¿‡åº¦è½¬ä¹‰
                                .replace(/\\\\/g, '\\');  // ä¿®å¤åæ–œæ 
                            
                            // ä¿®å¤æ¢è¡Œç¬¦é—®é¢˜
                            result = result
                                .replace(/\n/g, '\\n')
                                .replace(/\r/g, '\\r')
                                .replace(/\t/g, '\\t');
                            
                            result = JSON.parse(result);
                        } catch (e2) {
                            // è§£æå¤±è´¥ï¼Œå…è®¸é‡è¯•
                            if (retryCount < 2) {
                                console.warn(`[Geminiè°ƒè¯•] ç¬¬${retryCount+1}æ¬¡è§£æå¤±è´¥ï¼Œé‡è¯•...`);
                                await new Promise(res => setTimeout(res, 1000));
                                return await callGeminiAPI(prompt, responseSchema, schemaType, retryCount + 1);
                            } else {
                                console.error('[Geminiè°ƒè¯•] æœ€ç»ˆè§£æå¤±è´¥ï¼ŒåŸå§‹å†…å®¹:', result.slice(0, 500));
                                throw new Error('Geminiè¿”å›å†…å®¹ä¸æ˜¯åˆæ³•JSON: ' + result.slice(0, 200));
                            }
                        }
                    }
                }
                return result;
            } catch (error) {
                if (retryCount < 2) {
                    console.warn(`[Geminiè°ƒè¯•] APIè°ƒç”¨å¤±è´¥ï¼Œç¬¬${retryCount+1}æ¬¡é‡è¯•...`, error);
                    
                    // æ£€æŸ¥æ˜¯å¦æ˜¯é…é¢è¶…é™é”™è¯¯
                    if (error.message.includes('quota') || error.message.includes('Quota') || error.message.includes('exceeded')) {
                        console.warn('[Geminiè°ƒè¯•] æ£€æµ‹åˆ°é…é¢è¶…é™é”™è¯¯ï¼Œåç«¯ä¼šè‡ªåŠ¨åˆ‡æ¢åˆ°PROå¯†é’¥');
                        // å¯¹äºé…é¢è¶…é™é”™è¯¯ï¼Œç­‰å¾…æ›´é•¿æ—¶é—´å†é‡è¯•
                        await new Promise(res => setTimeout(res, 3000));
                    } else {
                        // å…¶ä»–é”™è¯¯ï¼Œæ­£å¸¸ç­‰å¾…
                        await new Promise(res => setTimeout(res, 1000));
                    }
                    
                    return await callGeminiAPI(prompt, responseSchema, schemaType, retryCount + 1);
                }
                throw new Error('Geminiåç«¯APIè°ƒç”¨å¤±è´¥: ' + error.message);
            }
        }

        // ä»ç¤ºä¾‹å¯¹è±¡è‡ªåŠ¨ç”ŸæˆJSON Schemaçš„å‡½æ•°
        function generateJsonSchemaFromExample(example) {
            if (example === null) {
                return { type: "null" };
            }
            
            if (Array.isArray(example)) {
                if (example.length === 0) {
                    return { type: "array", items: {} };
                }
                return {
                    type: "array",
                    items: generateJsonSchemaFromExample(example[0])
                };
            }
            
            if (typeof example === "object") {
                const properties = {};
                const required = [];
                
                for (const [key, value] of Object.entries(example)) {
                    properties[key] = generateJsonSchemaFromExample(value);
                    required.push(key);
                }
                
                return {
                    type: "object",
                    properties,
                    required
                };
            }
            
            return { type: typeof example };
        }
        
        async function extractPdfText(file) {
            const reader = new FileReader();
            return new Promise((resolve, reject) => {
                reader.onload = async (event) => {
                    try {
                        const pdfData = new Uint8Array(event.target.result);
                        const pdf = await pdfjsLib.getDocument({ data: pdfData }).promise;
                        let fullText = '';
                        for (let i = 1; i <= pdf.numPages; i++) {
                            const page = await pdf.getPage(i);
                            const textContent = await page.getTextContent();
                            fullText += textContent.items.map(item => item.str).join(' ');
                        }
                        // å»é™¤æ‰€æœ‰ç©ºæ ¼
                        fullText = fullText.replace(/\s+/g, '');
                        resolve(fullText);
                    } catch (error) {
                        reject(new Error("æ— æ³•è§£æPDFæ–‡ä»¶ã€‚"));
                    }
                };
                reader.onerror = () => reject(new Error("è¯»å–æ–‡ä»¶å¤±è´¥ã€‚"));
                reader.readAsArrayBuffer(file);
            });
        }


        // --- WORKFLOW NODE IMPLEMENTATIONS (WITH REAL API LOGIC) ---

        // ==== æ–°å¢ï¼šå¥å£®JSONä¿®å¤å‡½æ•°ï¼ˆç®€åŒ–ç‰ˆï¼Œå€Ÿé‰´server.js repairJsonResponseEnhancedï¼‰====
        function robustJsonRepair(text) {
            if (typeof text !== 'string') return text;
            let result = text;
            // å»é™¤markdownä»£ç å—
            result = result.replace(/```json[\s\S]*?```/g, m => m.replace(/```json|```/g, '').trim());
            result = result.replace(/```[\s\S]*?```/g, m => m.replace(/```/g, '').trim());
            // å°è¯•æå–ç¬¬ä¸€ä¸ªåˆæ³•JSONå¯¹è±¡æˆ–æ•°ç»„
            let jsonMatch = result.match(/({[\s\S]*}|\[[\s\S]*\])/);
            if (jsonMatch) {
                result = jsonMatch[0];
            }
            // å¸¸è§ä¿®å¤
            result = result
                .replace(/,\s*}/g, '}')
                .replace(/,\s*]/g, ']')
                .replace(/}\s*,\s*}/g, '}}')
                .replace(/]\s*,\s*]/g, ']]')
                .replace(/}\s*,\s*]/g, '}]')
                .replace(/]\s*,\s*}/g, ']}')
                // ä¿®å¤æ•°ç»„ä¸­çš„å¯¹è±¡ä¹‹é—´ç¼ºå°‘é€—å·
                .replace(/}\s*\{/g, '},{')
                .replace(/}\s*\[/g, '},[')
                .replace(/]\s*\{/g, '],{')
                .replace(/]\s*\[/g, '],[')
                // ä¿®å¤å­—ç¬¦ä¸²åç¼ºå°‘é€—å·
                .replace(/"\s*"/g, '","')
                .replace(/"\s*}/g, '",}')
                .replace(/"\s*]/g, '",]')
                .replace(/"\s*\{/g, '",{')
                .replace(/"\s*\[/g, '",[')
                // ä¿®å¤æ•°å­—åç¼ºå°‘é€—å·
                .replace(/(\d+)\s*"/g, '$1,"')
                .replace(/(\d+)\s*}/g, '$1,}')
                .replace(/(\d+)\s*]/g, '$1,]')
                .replace(/(\d+)\s*\{/g, '$1,{')
                .replace(/(\d+)\s*\[/g, '$1,[')
                // ä¿®å¤å¸ƒå°”å€¼å’Œnullåç¼ºå°‘é€—å·
                .replace(/(true|false|null)\s*"/g, '$1,"')
                .replace(/(true|false|null)\s*}/g, '$1,}')
                .replace(/(true|false|null)\s*]/g, '$1,]')
                .replace(/(true|false|null)\s*\{/g, '$1,{')
                .replace(/(true|false|null)\s*\[/g, '$1,[');
            // å°è¯•è¡¥å…¨ç¼ºå¤±çš„ç»“å°¾å¤§æ‹¬å·
            const leftBraces = (result.match(/{/g) || []).length;
            const rightBraces = (result.match(/}/g) || []).length;
            if (leftBraces > rightBraces) {
                result += '}'.repeat(leftBraces - rightBraces);
            }
            const leftBrackets = (result.match(/\[/g) || []).length;
            const rightBrackets = (result.match(/]/g) || []).length;
            if (leftBrackets > rightBrackets) {
                result += ']'.repeat(leftBrackets - rightBrackets);
            }
            return result;
        }
        // ==== END robustJsonRepair ====

        async function runNode1(state) {
            workflowState.currentNodeId = 1;
            workflowState.currentNodeName = "äº§å“ä¿¡æ¯æ·±åº¦æå–";
            console.log("=== èŠ‚ç‚¹1: äº§å“ä¿¡æ¯æ·±åº¦æå– ===");
            console.log("è¾“å…¥çŠ¶æ€:", state);
            
            let pdfTextContent = `æ–‡ä»¶å: ${uploadedPdfFile ? uploadedPdfFile.name : 'æœªæä¾›'}. `;
            if (uploadedPdfFile) {
                try {
                     updateStatus(1, 'æ­£åœ¨æå–PDFæ–‡æœ¬...', 'processing');
                     console.log("æ­£åœ¨æå–PDFæ–‡ä»¶å†…å®¹:", uploadedPdfFile.name);
                     pdfTextContent += await extractPdfText(uploadedPdfFile);
                     console.log("PDFæ–‡æœ¬æå–å®Œæˆï¼Œå†…å®¹é•¿åº¦:", pdfTextContent.length);
                } catch(e) {
                     console.warn("PDFæ–‡æœ¬æå–å¤±è´¥ï¼Œå°†ä½¿ç”¨æ–‡ä»¶åè¿›è¡Œåˆ†æã€‚", e);
                     pdfTextContent += "æ— æ³•æå–PDFå†…å®¹ï¼Œè¯·ç¡®ä¿æ–‡ä»¶æœªæŸåã€‚";
                }
            } else {
                console.log("æœªæä¾›PDFæ–‡ä»¶ï¼Œä½¿ç”¨é»˜è®¤äº§å“ä¿¡æ¯");
                pdfTextContent += "æ— PDFæ–‡ä»¶ï¼Œä½¿ç”¨é»˜è®¤äº§å“ä¿¡æ¯ã€‚";
            }
            // åˆå¹¶è¡¥å……æ–‡æœ¬ä¿¡æ¯
            if (supplementalText && supplementalText.trim().length > 0) {
                pdfTextContent += `\n\nã€è¡¥å……ä¿¡æ¯ã€‘ï¼š${supplementalText.trim()}`;
            }
            workflowState.pdfText = pdfTextContent; 

            const prompt = `ä½œä¸ºå°çº¢ä¹¦å¹³å°çš„å†…å®¹è¥é”€ç­–ç•¥ä¸“å®¶ï¼Œè¯·åŸºäºä»¥ä¸‹äº§å“ä¿¡æ¯ï¼Œæ„å»ºä¸€ä¸ªå®Œæ•´çš„äº§å“ä»·å€¼çŸ¥è¯†åº“ï¼š\n\n${pdfTextContent}\n\nè¯·ä»åŒ…æ‹¬ä½†ä¸å±€é™äºä»¥ä¸‹è§’åº¦æ·±å…¥åˆ†æï¼šç›®æ ‡ç”¨æˆ·ç”»åƒï¼ˆå¹´é¾„ã€èŒä¸šã€ç”Ÿæ´»æ–¹å¼ã€æ¶ˆè´¹ä¹ æƒ¯ç­‰ï¼‰ã€æ ¸å¿ƒä»·å€¼ä¸»å¼ ã€ç”¨æˆ·ç—›ç‚¹åˆ†æï¼ˆäº§å“è§£å†³çš„å…·ä½“é—®é¢˜ï¼‰ã€è§£å†³æ–¹æ¡ˆè¯¦è§£ï¼ˆäº§å“å¦‚ä½•è§£å†³è¿™äº›é—®é¢˜ï¼‰ã€äº§å“ä¼˜åŠ¿å¯¹æ¯”ï¼ˆä¸ç«å“ç›¸æ¯”çš„ç‹¬ç‰¹ä¼˜åŠ¿ï¼‰ã€å…¸å‹ä½¿ç”¨åœºæ™¯ã€æŠ€æœ¯äº®ç‚¹è§£æï¼ˆæ ¸å¿ƒæŠ€æœ¯å‚æ•°åŠå…¶ä»·å€¼ï¼‰ï¼Œå¦‚æœå…¶ä¸­ä¸å­˜åœ¨ä»¥ä¸Šä¿¡æ¯ï¼Œä¸è¦è‡ªè¡Œè‡†é€ ï¼Œè¯·æ±‡æ€»ä»¥ä¸Šäº§å“ä¿¡æ¯ï¼Œä»¥JSONæ ¼å¼è¾“å‡ºï¼Œã€‚JSONå­—æ®µåè¯·ä½¿ç”¨ä¸­æ–‡ã€‚`;
            console.log("å‘é€åˆ°Gemini APIçš„æç¤ºè¯:", prompt);
            
            let result = await callGeminiAPI(prompt, true);
            // ==== æ–°å¢å¥å£®ä¿®å¤ ====
            if (typeof result === 'string') {
                let repaired = robustJsonRepair(result);
                try {
                    result = JSON.parse(repaired);
                } catch (e) {
                    // å…œåº•ï¼šåªæˆªå–åˆ°æœ€åä¸€ä¸ªå®Œæ•´çš„}
                    const lastBrace = repaired.lastIndexOf('}');
                    if (lastBrace !== -1) {
                        try {
                            result = JSON.parse(repaired.slice(0, lastBrace + 1));
                        } catch (e2) {
                            result = { raw: repaired, error: e2.message };
                        }
                    } else {
                        result = { raw: repaired, error: e.message };
                    }
                }
            }
            // ==== END ====
            console.log("èŠ‚ç‚¹1è¾“å‡ºç»“æœ:", result);
            
            return { ...state, äº§å“å–ç‚¹: result };
        }

        async function runNode3(state) {
            workflowState.currentNodeId = 3;
            workflowState.currentNodeName = "ç”Ÿæˆå°çº¢ä¹¦å†…å®¹ä¸KOLç­–ç•¥";
            console.log("=== èŠ‚ç‚¹3: ç”Ÿæˆå°çº¢ä¹¦å†…å®¹ä¸KOLç­–ç•¥ ===");
            console.log("è¾“å…¥çŠ¶æ€:", state);
            
            const prompt = `ä½œä¸ºå°çº¢ä¹¦è¥é”€ä¸“å®¶ï¼Œè¯·åŸºäºä»¥ä¸‹äº§å“ä¿¡æ¯ï¼Œåˆ¶å®šå®Œæ•´çš„å†…å®¹è¥é”€ç­–ç•¥ï¼š\n\n${JSON.stringify(state.äº§å“å–ç‚¹)}\n\nè¯·ä½¿ç”¨ä¸­æ–‡ï¼Œè¯·ä»åŒ…æ‹¬ä½†ä¸å±€é™äºä»¥ä¸‹æ–¹é¢åˆ¶å®šç­–ç•¥ï¼š\n\n1. KOLç­–ç•¥ï¼š\n   - æ•´ä½“ç­–ç•¥æ€è·¯\n   - KOLå±‚çº§åˆ†å¸ƒå»ºè®®\n   - å„ç±»å‹KOLé€‰æ‹©æ ‡å‡†\n   - å†…å®¹é£æ ¼è¦æ±‚\n   - åˆä½œé‡ç‚¹æ–¹å‘\n\n2. å†…å®¹ç­–ç•¥ï¼š\n   - æ ¸å¿ƒä¼ æ’­ä¸»é¢˜\n   - é‡ç‚¹æ²Ÿé€šåœºæ™¯\n   - å†…å®¹æ–¹å‘å»ºè®®\n   - å†…å®¹åˆ›ä½œè§„èŒƒ\n   - å®¡ç¨¿æ ‡å‡†\n\nè¯·ä»¥JSONæ ¼å¼è¾“å‡ºï¼Œç¡®ä¿ç­–ç•¥å…·æœ‰å¯æ‰§è¡Œæ€§å’Œåˆ›æ–°æ€§ã€‚\nã€æ ¼å¼è¦æ±‚ã€‘ä¸¥æ ¼è¾“å‡ºåˆæ³•JSONï¼Œä¸è¦æœ‰å¤šä½™æ³¨é‡Šã€ä¸è¦æœ‰å¤šä½™æ–‡æœ¬ã€ä¸è¦æœ‰å¤šä½™çš„markdownä»£ç å—æ ‡è®°ï¼ˆå¦‚\`\`\`jsonï¼‰ã€‚`;
            console.log("å‘é€åˆ°Gemini APIçš„æç¤ºè¯:", prompt);
            
            let result = await callGeminiAPI(prompt, true);
            // ==== æ–°å¢å¥å£®ä¿®å¤ ====
            if (typeof result === 'string') {
                let repaired = robustJsonRepair(result);
                try {
                    result = JSON.parse(repaired);
                } catch (e) {
                    // å…œåº•ï¼šåªæˆªå–åˆ°æœ€åä¸€ä¸ªå®Œæ•´çš„}
                    const lastBrace = repaired.lastIndexOf('}');
                    if (lastBrace !== -1) {
                        try {
                            result = JSON.parse(repaired.slice(0, lastBrace + 1));
                        } catch (e2) {
                            result = { raw: repaired, error: e2.message };
                        }
                    } else {
                        result = { raw: repaired, error: e.message };
                    }
                }
            }
            // ==== END ====
            console.log("èŠ‚ç‚¹3åŸå§‹è¾“å‡ºç»“æœ:", result);
            
            // ç¡®ä¿ç»“æœæ ¼å¼æ­£ç¡®
            const formattedResult = {
                KOLåª’ä»‹ç­–ç•¥: { 
                    title: "KOLåª’ä»‹ç­–ç•¥", 
                    data: result.kol_strategy || result.KOLç­–ç•¥ || result 
                },
                å†…å®¹åˆ›ä½œç­–ç•¥åŠå®¡ç¨¿è§„åˆ™: { 
                    title: "å†…å®¹åˆ›ä½œç­–ç•¥ä»¥åŠå®¡ç¨¿è§„åˆ™", 
                    data: result.content_strategy || result.å†…å®¹ç­–ç•¥ || result 
                }
            };
            
            console.log("èŠ‚ç‚¹3æ ¼å¼åŒ–åçš„ç»“æœ:", formattedResult);
            return { ...state, ...formattedResult };
        }
        
        async function runNode4(state) {
            workflowState.currentNodeId = 4;
            workflowState.currentNodeName = "äººç¾¤åº“æ™ºèƒ½åŒ¹é…ä¸æ’åº";
            console.log("=== èŠ‚ç‚¹4: äººç¾¤åº“æ™ºèƒ½åŒ¹é…ä¸æ’åº ===");
            // æ£€æŸ¥ç¼“å­˜ä¸­çš„å…¨é‡äººç¾¤æ•°æ®
            const allAudiences = fileCache['å…¨é‡äººç¾¤.json'] || [];
            console.log("ç¼“å­˜ä¸­çš„å…¨é‡äººç¾¤æ•°æ®:", {
                totalCount: allAudiences.length,
                sampleData: allAudiences.slice(0, 2)
            });
            // é¢„å¤„ç†äººç¾¤æ•°æ®ï¼Œåªä¿ç•™å¿…è¦å­—æ®µ
            const simplifiedAudiences = allAudiences.map(audience => ({
                groupName: audience.groupName || "",
                typeOption: audience.typeOption || "",
                industryOption: audience.industryOption || "",
                groupDesc: audience.groupDesc || "",
                coverNum: audience.coverNum || 0,
                äººç¾¤ç±»å‹: audience.äººç¾¤ç±»å‹ || ""
            }));
            // åˆ¤æ–­æ¨¡å‹
            if (GEMINI_MODEL === 'gemini-2.5-pro-preview-06-05') {
                // --- proæ¨¡å‹ï¼šå•äººç¾¤åˆ†æ‰¹å¹¶å‘ ---
                const BATCH_SIZE = 10;
                const batches = [];
                for (let i = 0; i < simplifiedAudiences.length; i += BATCH_SIZE) {
                    batches.push(simplifiedAudiences.slice(i, i + BATCH_SIZE));
                }
                console.log(`proæ¨¡å‹ï¼šå°†äººç¾¤æ•°æ®åˆ†ä¸º ${batches.length} æ‰¹ï¼Œæ¯æ‰¹ ${BATCH_SIZE} ä¸ª`);
                let allResults = [];
                let totalProcessed = 0;
                let totalMatched = 0;
                let totalRejected = 0;
                for (let batchIdx = 0; batchIdx < batches.length; batchIdx++) {
                    const batch = batches[batchIdx];
                    console.log(`å¤„ç†ç¬¬${batchIdx+1}æ‰¹/${batches.length}...`);
                    // å¹¶å‘å¤„ç†æœ¬æ‰¹æ‰€æœ‰äººç¾¤
                    const results = await Promise.all(batch.map(async (aud, idx) => {
                        const prompt = `ä½œä¸ºäººç¾¤åˆ†æä¸“å®¶ï¼Œè¯·åŸºäºä»¥ä¸‹äº§å“ä¿¡æ¯å’Œå†…å®¹ç­–ç•¥ï¼Œå¯¹ç›®æ ‡äººç¾¤è¿›è¡Œæ™ºèƒ½åŒ¹é…å’Œæ‰“åˆ†ï¼š\n\näº§å“ä¿¡æ¯ï¼š\n${JSON.stringify(state.äº§å“å–ç‚¹, null, 2)}\n\nå†…å®¹ç­–ç•¥ï¼š\n${JSON.stringify(state.å†…å®¹åˆ›ä½œç­–ç•¥åŠå®¡ç¨¿è§„åˆ™.data, null, 2)}\n\nå½“å‰äººç¾¤æ•°æ®ï¼š\n${JSON.stringify(aud, null, 2)}\n\nè¯·å¯¹è¯¥äººç¾¤è¿›è¡Œä»¥ä¸‹åˆ†æï¼š\n1. åˆ†æindustryOptionå­—æ®µä¸äº§å“å–ç‚¹çš„åŒ¹é…åº¦\n2. å¦‚æœindustryOptionä¸ºç©ºï¼Œåˆ™åˆ†ægroupNameå’ŒgroupDescä¸äº§å“å–ç‚¹çš„åŒ¹é…åº¦\n3. ç»™å‡º0-100çš„è¯„åˆ†ï¼Œå¹¶è¯¦ç»†è¯´æ˜è¯„åˆ†ç†ç”±\n4. å¦‚æœä¸äº§å“å®Œå…¨æ— å…³ï¼Œç›´æ¥æ‹’ç»ï¼ˆä¸è¾“å‡ºè¯¥äººç¾¤ï¼‰\n\nè¯·ä»¥JSONæ ¼å¼è¾“å‡ºï¼Œæ ¼å¼è¦æ±‚ï¼š\n{\n  "matchedCrowds": [\n    {\n      "groupName": "äººç¾¤åç§°",\n      "typeOption": "äººç¾¤ç±»å‹",\n      "industryOption": "è¡Œä¸š",\n      "groupDesc": "äººç¾¤æè¿°",\n      "coverNum": è¦†ç›–äººæ•°,\n      "äººç¾¤ç±»å‹": "äººç¾¤ç±»å‹",\n      "score": è¯„åˆ†(0-100),\n      "reasoning": "è¯¦ç»†çš„è¯„åˆ†ç†ç”±"\n    }\n  ],\n  "batchStatistics": {\n    "totalProcessed": 1,\n    "matchedCount": åŒ¹é…äººæ•°,\n    "rejectedCount": æ‹’ç»äººæ•°,\n    "rejectionReasons": ["è¢«æ‹’ç»çš„ä¸»è¦åŸå› "]\n  }\n}`;
                        
                        let retry = 0;
                        const maxRetries = 3;
                        while (retry < maxRetries) {
                            try {
                                const result = await callGeminiAPI(prompt, true, 'crowd');
                                if (result && result.matchedCrowds && result.matchedCrowds.length > 0) {
                                    // éªŒè¯æ•°æ®å®Œæ•´æ€§ï¼Œç¡®ä¿æ¯ä¸ªå­—æ®µéƒ½æ­£ç¡®å¯¹åº”
                                    const validatedCrowds = result.matchedCrowds.map(crowd => {
                                        // ç¡®ä¿æ•°æ®å­—æ®µä¸åŸå§‹äººç¾¤å¯¹åº”
                                        return {
                                            groupName: crowd.groupName || aud.groupName,
                                            typeOption: crowd.typeOption || aud.typeOption,
                                            industryOption: crowd.industryOption || aud.industryOption,
                                            groupDesc: crowd.groupDesc || aud.groupDesc,
                                            coverNum: crowd.coverNum || aud.coverNum,
                                            äººç¾¤ç±»å‹: crowd.äººç¾¤ç±»å‹ || aud.äººç¾¤ç±»å‹,
                                            score: crowd.score || 50,
                                            reasoning: crowd.reasoning || "APIè¿”å›æ•°æ®ä¸å®Œæ•´"
                                        };
                                    });
                                    allResults = allResults.concat(validatedCrowds);
                                    totalMatched += validatedCrowds.length;
                                }
                                if (result && result.batchStatistics) {
                                    totalProcessed += result.batchStatistics.totalProcessed || 1;
                                    totalRejected += result.batchStatistics.rejectedCount || 0;
                                    console.log(`å•äººç¾¤ç»Ÿè®¡:`, result.batchStatistics);
                                }
                                return; // æˆåŠŸåˆ™é€€å‡ºé‡è¯•å¾ªç¯
                            } catch (error) {
                                retry++;
                                console.warn(`å•äººç¾¤ç¬¬${retry}æ¬¡å°è¯•å¤±è´¥:`, error.message);
                                
                                if (retry >= maxRetries) {
                                    console.error(`å•äººç¾¤è¿ç»­${maxRetries}æ¬¡å¤±è´¥ï¼Œè·³è¿‡è¯¥äººç¾¤`);
                                    totalProcessed += 1;
                                    totalRejected += 1;
                                    // ä¸å†ä¸ºå¤±è´¥çš„äººç¾¤ç”Ÿæˆé»˜è®¤ç»“æœï¼Œé¿å…æ•°æ®é”™é…
                                } else {
                                    // ç­‰å¾…æ—¶é—´é€’å¢
                                    await new Promise(res => setTimeout(res, 1000 * retry));
                                }
                            }
                        }
                    }));
                    // ç­‰å¾…æœ¬æ‰¹å…¨éƒ¨å®Œæˆåå†å¤„ç†ä¸‹ä¸€æ‰¹
                }
                // æŒ‰è¯„åˆ†æ’åºï¼Œå–å‰40ä¸ª
                allResults.sort((a, b) => (b.score || 0) - (a.score || 0));
                const top40 = allResults.slice(0, 40);
                const allResultsExcel = { data: allResults.map(p => ({
                    'äººç¾¤åç§°': p.groupName, 'äººç¾¤ç±»å‹': p.typeOption, 'è¡Œä¸š': p.industryOption,
                    'äººç¾¤æè¿°': p.groupDesc, 'è¦†ç›–äººæ•°': p.coverNum, 'è¯„åˆ†': p.score, 'æ‰“åˆ†ç†ç”±': p.reasoning
                })) };
                const formattedResult = {
                    åˆå¹¶äººç¾¤_40: {
                        matchedCrowds: top40,
                        statistics: {
                            totalAnalyzed: allAudiences.length,
                            matchedCount: totalMatched,
                            rejectedCount: totalRejected,
                            outputCount: top40.length,
                            matchRate: `${((totalMatched / allAudiences.length) * 100).toFixed(2)}%`,
                            rejectionRate: `${((totalRejected / allAudiences.length) * 100).toFixed(2)}%`
                        }
                    },
                    allResultsExcel
                };
                console.log("èŠ‚ç‚¹4æ ¼å¼åŒ–åçš„ç»“æœ:", formattedResult);
                return { ...state, ...formattedResult };
            } else {
                // --- å…¶å®ƒæ¨¡å‹ï¼Œä¿æŒåŸæœ‰æ‰¹é‡prompté€»è¾‘ ---
                const BATCH_SIZE = 20; // æ¯æ‰¹å¤„ç†20ä¸ªäººç¾¤
                const batches = [];
                for (let i = 0; i < simplifiedAudiences.length; i += BATCH_SIZE) {
                    batches.push(simplifiedAudiences.slice(i, i + BATCH_SIZE));
                }
                console.log(`å°†äººç¾¤æ•°æ®åˆ†ä¸º ${batches.length} æ‰¹å¤„ç†ï¼Œæ¯æ‰¹ ${BATCH_SIZE} ä¸ªäººç¾¤`);
                let allResults = [];
                let totalProcessed = 0;
                let totalMatched = 0;
                let totalRejected = 0;
                // å¹¶å‘å¤„ç†ï¼Œæ¯æ¬¡æœ€å¤š10ä¸ªæ‰¹æ¬¡
                const CONCURRENT_LIMIT = 10;
                let batchIndex = 0;
                while (batchIndex < batches.length) {
                    const currentBatchGroup = batches.slice(batchIndex, batchIndex + CONCURRENT_LIMIT);
                    const promises = currentBatchGroup.map((batch, idx) => {
                        const realIndex = batchIndex + idx;
                        const prompt = `ä½œä¸ºäººç¾¤åˆ†æä¸“å®¶ï¼Œè¯·åŸºäºä»¥ä¸‹äº§å“ä¿¡æ¯å’Œå†…å®¹ç­–ç•¥ï¼Œå¯¹ç›®æ ‡äººç¾¤è¿›è¡Œæ™ºèƒ½åŒ¹é…å’Œæ‰“åˆ†ï¼š\n\näº§å“ä¿¡æ¯ï¼š\n${JSON.stringify(state.äº§å“å–ç‚¹, null, 2)}\n\nå†…å®¹ç­–ç•¥ï¼š\n${JSON.stringify(state.å†…å®¹åˆ›ä½œç­–ç•¥åŠå®¡ç¨¿è§„åˆ™.data, null, 2)}\n\nå½“å‰æ‰¹æ¬¡äººç¾¤æ•°æ®ï¼ˆç¬¬${realIndex + 1}æ‰¹ï¼Œå…±${batches.length}æ‰¹ï¼‰ï¼š\n${JSON.stringify(batch, null, 2)}\n\nè¯·å¯¹ä¸Šè¿°äººç¾¤æ•°æ®è¿›è¡Œä»¥ä¸‹åˆ†æï¼š\n1. åˆ†æäººç¾¤çš„industryOptionå­—æ®µä¸äº§å“å–ç‚¹çš„åŒ¹é…åº¦\n2. å¦‚æœindustryOptionä¸ºç©ºï¼Œåˆ™åˆ†ægroupNameå’ŒgroupDescä¸äº§å“å–ç‚¹çš„åŒ¹é…åº¦\n3. å¯¹äºæ¯ä¸ªåŒ¹é…çš„äººç¾¤ï¼Œç»™å‡º0-100çš„è¯„åˆ†ï¼Œå¹¶è¯¦ç»†è¯´æ˜è¯„åˆ†ç†ç”±\n4. åˆ é™¤ä¸äº§å“å®Œå…¨æ— å…³çš„äººç¾¤\n\nè¯·ä»¥JSONæ ¼å¼è¾“å‡ºï¼Œæ ¼å¼è¦æ±‚ï¼š\n{\n    "matchedCrowds": [\n        {\n            "groupName": "äººç¾¤åç§°",\n            "typeOption": "äººç¾¤ç±»å‹",\n            "industryOption": "è¡Œä¸š",\n            "groupDesc": "äººç¾¤æè¿°",\n            "coverNum": è¦†ç›–äººæ•°,\n            "äººç¾¤ç±»å‹": "äººç¾¤ç±»å‹",\n            "score": è¯„åˆ†(0-100),\n            "reasoning": "è¯¦ç»†çš„è¯„åˆ†ç†ç”±"\n        }\n    ],\n    "batchStatistics": {\n        "totalProcessed": "æœ¬æ‰¹æ¬¡å¤„ç†çš„æ€»äººæ•°",\n        "matchedCount": "æœ¬æ‰¹æ¬¡åŒ¹é…çš„äººæ•°",\n        "rejectedCount": "æœ¬æ‰¹æ¬¡è¢«æ‹’ç»çš„äººæ•°",\n        "rejectionReasons": ["è¢«æ‹’ç»çš„ä¸»è¦åŸå› "]\n    }\n}`;
                        // å¢åŠ é‡è¯•æœºåˆ¶
                        return (async () => {
                            let retry = 0;
                            const maxRetries = 3;
                            while (retry < maxRetries) {
                                try {
                                    const result = await callGeminiAPI(prompt, true, 'crowd');
                                    if (result && result.matchedCrowds) {
                                        // éªŒè¯æ•°æ®å®Œæ•´æ€§ï¼Œç¡®ä¿æ¯ä¸ªå­—æ®µéƒ½æ­£ç¡®å¯¹åº”
                                        const validatedCrowds = result.matchedCrowds.map(crowd => {
                                            // åœ¨æ‰¹æ¬¡ä¸­æ‰¾åˆ°å¯¹åº”çš„äººç¾¤æ•°æ®
                                            const originalCrowd = batch.find(b => b.groupName === crowd.groupName);
                                            return {
                                                groupName: crowd.groupName || (originalCrowd ? originalCrowd.groupName : ''),
                                                typeOption: crowd.typeOption || (originalCrowd ? originalCrowd.typeOption : ''),
                                                industryOption: crowd.industryOption || (originalCrowd ? originalCrowd.industryOption : ''),
                                                groupDesc: crowd.groupDesc || (originalCrowd ? originalCrowd.groupDesc : ''),
                                                coverNum: crowd.coverNum || (originalCrowd ? originalCrowd.coverNum : 0),
                                                äººç¾¤ç±»å‹: crowd.äººç¾¤ç±»å‹ || (originalCrowd ? originalCrowd.äººç¾¤ç±»å‹ : ''),
                                                score: crowd.score || 50,
                                                reasoning: crowd.reasoning || "APIè¿”å›æ•°æ®ä¸å®Œæ•´"
                                            };
                                        });
                                        allResults = allResults.concat(validatedCrowds);
                                        totalMatched += validatedCrowds.length;
                                    }
                                    if (result && result.batchStatistics) {
                                        totalProcessed += result.batchStatistics.totalProcessed;
                                        totalRejected += result.batchStatistics.rejectedCount;
                                        console.log(`æ‰¹æ¬¡ ${realIndex + 1} ç»Ÿè®¡:`, result.batchStatistics);
                                    }
                                    return; // æˆåŠŸåˆ™é€€å‡ºé‡è¯•å¾ªç¯
                                } catch (error) {
                                    retry++;
                                    console.warn(`æ‰¹æ¬¡ ${realIndex + 1} ç¬¬${retry}æ¬¡å°è¯•å¤±è´¥:`, error.message);
                                    
                                    if (retry >= maxRetries) {
                                        console.error(`æ‰¹æ¬¡ ${realIndex + 1} è¿ç»­${maxRetries}æ¬¡å¤±è´¥ï¼Œè·³è¿‡è¯¥æ‰¹æ¬¡`);
                                        totalProcessed += batch.length;
                                        totalRejected += batch.length;
                                        // ä¸å†ä¸ºå¤±è´¥çš„æ‰¹æ¬¡ç”Ÿæˆé»˜è®¤ç»“æœï¼Œé¿å…æ•°æ®é”™é…
                                    } else {
                                        // ç­‰å¾…æ—¶é—´é€’å¢
                                        await new Promise(res => setTimeout(res, 1000 * retry));
                                    }
                                }
                            }
                        })();
                    });
                    await Promise.all(promises);
                    batchIndex += CONCURRENT_LIMIT;
                }
                // æŒ‰è¯„åˆ†æ’åºï¼Œå–å‰40ä¸ª
                allResults.sort((a, b) => (b.score || 0) - (a.score || 0));
                const top40 = allResults.slice(0, 40);
                const allResultsExcel = { data: allResults.map(p => ({
                    'äººç¾¤åç§°': p.groupName, 'äººç¾¤ç±»å‹': p.typeOption, 'è¡Œä¸š': p.industryOption,
                    'äººç¾¤æè¿°': p.groupDesc, 'è¦†ç›–äººæ•°': p.coverNum, 'è¯„åˆ†': p.score, 'æ‰“åˆ†ç†ç”±': p.reasoning
                })) };
                const formattedResult = {
                    åˆå¹¶äººç¾¤_40: {
                        matchedCrowds: top40,
                        statistics: {
                            totalAnalyzed: allAudiences.length,
                            matchedCount: totalMatched,
                            rejectedCount: totalRejected,
                            outputCount: top40.length,
                            matchRate: `${((totalMatched / allAudiences.length) * 100).toFixed(2)}%`,
                            rejectionRate: `${((totalRejected / allAudiences.length) * 100).toFixed(2)}%`
                        }
                    },
                    allResultsExcel
                };
                console.log("èŠ‚ç‚¹4æ ¼å¼åŒ–åçš„ç»“æœ:", formattedResult);
                return { ...state, ...formattedResult };
            }
        }

        async function runNode5(state) {
            workflowState.currentNodeId = 5;
            workflowState.currentNodeName = "AIé©±åŠ¨çš„æ–°äººç¾¤æ¢ç´¢ä¸æ•´åˆ";
            console.log("=== èŠ‚ç‚¹5: AIé©±åŠ¨çš„æ–°äººç¾¤æ¢ç´¢ä¸æ•´åˆ ===");
            console.log("è¾“å…¥çŠ¶æ€:", state);

            // è·å–èŠ‚ç‚¹4è¾“å‡ºçš„40ä¸ªé«˜åˆ†äººç¾¤
            const highScoringCrowds = state.åˆå¹¶äººç¾¤_40.matchedCrowds;
            console.log(`ä½¿ç”¨èŠ‚ç‚¹4è¾“å‡ºçš„${highScoringCrowds.length}ä¸ªé«˜åˆ†äººç¾¤è¿›è¡Œæ–°äººç¾¤æ¢ç´¢`);

            // ä¼˜åŒ–ï¼šåªä½¿ç”¨å‰10ä¸ªé«˜åˆ†äººç¾¤ä½œä¸ºå‚è€ƒï¼Œå‡å°‘tokenæ•°é‡
            const top10Crowds = highScoringCrowds.slice(0, 10);
            
            // æå–å…³é”®ç‰¹å¾ï¼Œè€Œä¸æ˜¯å®Œæ•´JSON
            const crowdFeatures = top10Crowds.map(crowd => ({
                name: crowd.groupName,
                type: crowd.typeOption,
                industry: crowd.industryOption,
                description: crowd.groupDesc?.substring(0, 100) + '...', // æˆªæ–­æè¿°
                score: crowd.score
            }));

            const prompt = `**è§’è‰²**: ä½ æ˜¯ä¸€ä½å¯Œæœ‰åˆ›é€ åŠ›çš„å¸‚åœºç­–ç•¥å¸ˆã€‚

**ä»»åŠ¡**: åŸºäºå·²æœ‰çš„é«˜åˆ†äººç¾¤ç‰¹å¾ï¼Œé¢å¤–æ¢ç´¢5-10ä¸ªåŒ¹é…æœ¬äº§å“çš„æ–°äººç¾¤ã€‚

**å·²æœ‰é«˜åˆ†äººç¾¤ç‰¹å¾**ï¼ˆå‰10ä¸ªï¼‰:
${JSON.stringify(crowdFeatures, null, 2)}

**äº§å“æ ¸å¿ƒä¿¡æ¯**:
${JSON.stringify({
    ç›®æ ‡ç”¨æˆ·: state.äº§å“å–ç‚¹?.ç›®æ ‡ç”¨æˆ·ç”»åƒ || 'æœªæä¾›',
    æ ¸å¿ƒä»·å€¼: state.äº§å“å–ç‚¹?.æ ¸å¿ƒä»·å€¼ä¸»å¼  || 'æœªæä¾›',
    ä½¿ç”¨åœºæ™¯: state.äº§å“å–ç‚¹?.å…¸å‹ä½¿ç”¨åœºæ™¯ || 'æœªæä¾›'
}, null, 2)}

**è¦æ±‚**:
1. åˆ†æå·²æœ‰é«˜åˆ†äººç¾¤çš„å…±åŒç‰¹å¾å’Œæ¨¡å¼
2. é¢å¤–æ¢ç´¢5-10ä¸ªå…¨æ–°çš„ã€é«˜æ½œåŠ›çš„ç›®æ ‡äººç¾¤
3. æ–°äººç¾¤å¿…é¡»æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š
   - ä¸äº§å“é«˜åº¦ç›¸å…³
   - å…·æœ‰ç‹¬ç‰¹çš„ä»·å€¼ä¸»å¼ 
   - æœ‰æ˜ç¡®çš„æ¶ˆè´¹åœºæ™¯
   - ä¸èƒ½ä¸å·²æœ‰é«˜åˆ†äººç¾¤é‡å¤
   - ä¸èƒ½ä½¿ç”¨å…¨é‡äººç¾¤æ•°æ®ä¸­å·²æœ‰çš„äººç¾¤
   - æ‰“åˆ†è§„åˆ™å¿…é¡»ä¸å·²æœ‰é«˜åˆ†äººç¾¤ä¿æŒä¸€è‡´
4. æ–°äººç¾¤çš„ç‰¹å®šè¦æ±‚ï¼š
   - typeOption å¿…é¡»è®¾ç½®ä¸º "AIæ¢ç´¢"
   - coverNum è®¾ç½®ä¸ºç©ºå­—ç¬¦ä¸²
   - æ¯ä¸ªæ–°äººç¾¤éƒ½éœ€è¦è¯¦ç»†çš„è¯„åˆ†ç†ç”±

**è¾“å‡ºæ ¼å¼**:
{
  "matchedCrowds": [
    {
      "groupName": "äººç¾¤åç§°",
      "typeOption": "AIæ¢ç´¢",
      "industryOption": "ç›¸å…³è¡Œä¸š",
      "groupDesc": "è¯¦ç»†çš„äººç¾¤æè¿°",
      "coverNum": "",
      "äººç¾¤ç±»å‹": "AIæ¢ç´¢",
      "score": 85,
      "reasoning": "è¯¦ç»†çš„è¯„åˆ†ç†ç”±"
    }
  ]
}

è¯·ä»¥JSONæ ¼å¼è¾“å‡ºï¼Œç¡®ä¿æ ¼å¼æ­£ç¡®ã€‚`;
            
            // å¢åŠ é‡è¯•æœºåˆ¶å’Œé”™è¯¯å¤„ç†
            let result;
            let retryCount = 0;
            const maxRetries = 3;
            
            while (retryCount < maxRetries) {
                try {
                    result = await callGeminiAPI(prompt, true, 'crowd');
                    
                    // éªŒè¯æ–°æ¢ç´¢äººç¾¤çš„æ•°æ®å®Œæ•´æ€§
                    if (result && result.matchedCrowds && result.matchedCrowds.length > 0) {
                        const validatedNewCrowds = result.matchedCrowds.map(crowd => {
                            // ç¡®ä¿æ–°äººç¾¤æ•°æ®å®Œæ•´ä¸”ç¬¦åˆè¦æ±‚
                            return {
                                groupName: crowd.groupName || `AIæ¢ç´¢äººç¾¤${Math.random().toString(36).substr(2, 5)}`,
                                typeOption: "AIæ¢ç´¢",
                                industryOption: crowd.industryOption || "AIæ¢ç´¢",
                                groupDesc: crowd.groupDesc || "AIæ¢ç´¢ç”Ÿæˆçš„äººç¾¤",
                                coverNum: "",
                                äººç¾¤ç±»å‹: "AIæ¢ç´¢",
                                score: crowd.score || 70,
                                reasoning: crowd.reasoning || "AIæ¢ç´¢ç”Ÿæˆçš„äººç¾¤"
                            };
                        });
                        
                        // éªŒè¯æ–°äººç¾¤ä¸ä¸ç°æœ‰äººç¾¤é‡å¤
                        const existingNames = highScoringCrowds.map(c => c.groupName);
                        const uniqueNewCrowds = validatedNewCrowds.filter(crowd => 
                            !existingNames.includes(crowd.groupName)
                        );
                        
                        result.matchedCrowds = uniqueNewCrowds;
                        console.log(`AIæ¢ç´¢æˆåŠŸï¼Œç”Ÿæˆ${uniqueNewCrowds.length}ä¸ªæ–°äººç¾¤`);
                    }
                    
                    break; // æˆåŠŸåˆ™è·³å‡ºå¾ªç¯
                } catch (error) {
                    retryCount++;
                    console.warn(`èŠ‚ç‚¹5ç¬¬${retryCount}æ¬¡å°è¯•å¤±è´¥:`, error.message);
                    
                    if (retryCount >= maxRetries) {
                        console.warn('èŠ‚ç‚¹5 AIæ¢ç´¢å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆç”Ÿæˆäººç¾¤æ•°æ®');
                        // å¤‡ç”¨æ–¹æ¡ˆï¼šåŸºäºç°æœ‰é«˜åˆ†äººç¾¤ç”Ÿæˆå˜ä½“
                        result = generateBackupCrowds(highScoringCrowds, state.äº§å“å–ç‚¹);
                        break;
                    }
                    
                    // ç­‰å¾…æ—¶é—´é€’å¢
                    await new Promise(res => setTimeout(res, 2000 * retryCount));
                }
            }
            
            const newCrowds = result?.matchedCrowds || [];
            
            // åˆå¹¶åŸæœ‰é«˜åˆ†äººç¾¤å’Œæ–°æ¢ç´¢çš„äººç¾¤
            const combined = [...highScoringCrowds, ...newCrowds].sort((a,b) => (b.score || 0) - (a.score || 0));
            
            // Excel æ•°æ®
            const finalMergedExcel = { data: combined.map(p => ({
                'äººç¾¤åç§°': p.groupName, 'äººç¾¤ç±»å‹': p.typeOption, 'è¡Œä¸š': p.industryOption,
                'äººç¾¤æè¿°': p.groupDesc, 'è¦†ç›–äººæ•°': p.coverNum, 'è¯„åˆ†': p.score, 'æ‰“åˆ†ç†ç”±': p.reasoning
            })) };
            
            console.log(`èŠ‚ç‚¹5å®Œæˆï¼š
- åŸæœ‰é«˜åˆ†äººç¾¤: ${highScoringCrowds.length}ä¸ª
- æ–°å¢æ¢ç´¢äººç¾¤: ${newCrowds.length}ä¸ª
- æœ€ç»ˆåˆå¹¶äººç¾¤: ${combined.length}ä¸ª`);

            return { ...state, æœ€ç»ˆåˆå¹¶äººç¾¤: { matchedCrowds: combined }, finalMergedExcel };
        }

        // å¤‡ç”¨äººç¾¤ç”Ÿæˆå‡½æ•°
        function generateBackupCrowds(highScoringCrowds, productInfo) {
            console.log('ä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆç”Ÿæˆäººç¾¤æ•°æ®');
            
            const backupCrowds = [];
            const industries = ['ç¾å¦†æŠ¤è‚¤', 'æ—¶å°šé…é¥°', 'ç”Ÿæ´»æ–¹å¼', 'å¥åº·å…»ç”Ÿ', 'æ•°ç ç§‘æŠ€', 'å®¶å±…ç”Ÿæ´»'];
            
            // åŸºäºç°æœ‰é«˜åˆ†äººç¾¤ç”Ÿæˆå˜ä½“
            highScoringCrowds.slice(0, 5).forEach((crowd, index) => {
                const baseScore = crowd.score || 80;
                const variations = [
                    {
                        groupName: `${crowd.groupName}ï¼ˆæ·±åº¦ç”¨æˆ·ï¼‰`,
                        typeOption: "AIæ¢ç´¢",
                        industryOption: crowd.industryOption || industries[index % industries.length],
                        groupDesc: `åŸºäº${crowd.groupName}çš„æ·±åº¦ç”¨æˆ·ç¾¤ä½“ï¼Œå…·æœ‰æ›´å¼ºçš„æ¶ˆè´¹èƒ½åŠ›å’Œå“ç‰Œå¿ è¯šåº¦`,
                        coverNum: "",
                        äººç¾¤ç±»å‹: "AIæ¢ç´¢",
                        score: Math.min(100, baseScore + 5),
                        reasoning: `åŸºäºåŸäººç¾¤${crowd.groupName}çš„æ·±åº¦ç”¨æˆ·å˜ä½“ï¼Œå…·æœ‰æ›´é«˜çš„æ¶ˆè´¹æ½œåŠ›`
                    },
                    {
                        groupName: `${crowd.groupName}ï¼ˆæ–°å…´å¸‚åœºï¼‰`,
                        typeOption: "AIæ¢ç´¢",
                        industryOption: crowd.industryOption || industries[index % industries.length],
                        groupDesc: `åŸºäº${crowd.groupName}çš„æ–°å…´å¸‚åœºç”¨æˆ·ï¼Œå…·æœ‰æˆé•¿æ½œåŠ›å’Œåˆ›æ–°æ¶ˆè´¹ä¹ æƒ¯`,
                        coverNum: "",
                        äººç¾¤ç±»å‹: "AIæ¢ç´¢",
                        score: Math.max(60, baseScore - 10),
                        reasoning: `åŸºäºåŸäººç¾¤${crowd.groupName}çš„æ–°å…´å¸‚åœºå˜ä½“ï¼Œå…·æœ‰æˆé•¿æ½œåŠ›`
                    }
                ];
                backupCrowds.push(...variations);
            });
            
            return { matchedCrowds: backupCrowds };
        }

        async function runNode6(state) {
             workflowState.currentNodeId = 6;
             workflowState.currentNodeName = "ç­›é€‰å¹¶è¾“å‡ºTop30æ ¸å¿ƒäººç¾¤";
            console.log("èŠ‚ç‚¹ 6: æœ¬åœ°æ•°æ®å¤„ç† - ç­›é€‰Top 30...");
            const top30 = state.æœ€ç»ˆåˆå¹¶äººç¾¤.matchedCrowds.slice(0, 30);
            const dataForExcel = top30.map(p => ({
                'äººç¾¤åç§°': p.groupName, 'äººç¾¤ç±»å‹': p.typeOption, 'è¡Œä¸š': p.industryOption,
                'äººç¾¤æè¿°': p.groupDesc, 'è¦†ç›–äººæ•°': p.coverNum, 'è¯„åˆ†': p.score, 'æ‰“åˆ†ç†ç”±': p.reasoning
            }));
            const top30Excel = { data: dataForExcel };
            return { ...state, äººç¾¤é«˜åˆ†: { data: dataForExcel, raw: top30 }, top30Excel };
        }
        
        async function runNode7(state) {
            workflowState.currentNodeId = 7;
            workflowState.currentNodeName = "äººç¾¤åœºæ™¯æ´å¯Ÿä¸å°çº¢ä¹¦è¯æœ¯ç”Ÿæˆ";
            const highScorerSamples = state.äººç¾¤é«˜åˆ†.raw; 
            const productInfo = JSON.stringify(state.äº§å“å–ç‚¹);
            const contentStrategy = JSON.stringify(state.å†…å®¹åˆ›ä½œç­–ç•¥åŠå®¡ç¨¿è§„åˆ™);

            // å•äººç¾¤promptæ¨¡æ¿
            function buildPrompt(crowd) {
                return `ä½ æ˜¯ä¸€ä½èµ„æ·±æ•´åˆè¥é”€å†…å®¹ä¸“å®¶ï¼Œè¯·åŸºäºä»¥ä¸‹è¾“å…¥æ•°æ®ï¼Œå®Œæˆæ·±åº¦äººç¾¤åˆ†æä¸åœºæ™¯åŒ–å†…å®¹ç”Ÿæˆï¼š\n\nã€è¾“å…¥æ•°æ®ã€‘\n[äººç¾¤]JSONæ•°æ®: ${JSON.stringify(crowd)}\n[äº§å“å–ç‚¹]JSONæ•°æ®: ${productInfo}\n[å†…å®¹ç­–ç•¥]JSONæ•°æ®: ${contentStrategy}\n\nã€æ ¸å¿ƒä»»åŠ¡ä¸æµç¨‹ã€‘\n1. ç²¾ç»†åŒ–äººç¾¤æ‹“å±•ä¸æ´å¯Ÿï¼š\n  - é’ˆå¯¹è¯¥äººç¾¤ï¼Œæ‹“å±•3-5ä¸ªæ›´å…·ä½“ã€æ›´ç»†åˆ†çš„"å…¸å‹äººç¾¤"ï¼ŒåŠ¡å¿…å‚è€ƒgroupNameå’ŒgroupDescï¼Œæ·±å…¥æŒ–æ˜ä¿¡æ¯ï¼Œç¡®ä¿æ¯ä¸ª"å…¸å‹äººç¾¤"ç”»åƒç»†èŠ‚ä¸°å¯Œã€åœºæ™¯æ„Ÿå¼ºã€‚\n  - å¯¹æ¯ä¸ª"å…¸å‹äººç¾¤"è¿›è¡Œå¦‚ä¸‹åˆ†æä¸å†…å®¹åˆ›ä½œï¼š\n    - è¯†åˆ«"éœ€æ±‚ç—›ç‚¹"ï¼šé˜è¿°è¯¥å…¸å‹äººç¾¤åœ¨ç‰¹å®šåœºæ™¯ä¸‹çš„å…·ä½“éœ€æ±‚æˆ–æœªè¢«æ»¡è¶³çš„ç—›ç‚¹ã€‚\n    - åŒ¹é…"äº§å“å–ç‚¹"ï¼šæ˜ç¡®æŒ‡å‡ºèƒ½æ»¡è¶³ä¸Šè¿°éœ€æ±‚ç—›ç‚¹çš„äº§å“å–ç‚¹ã€‚\n    - æ‹“å±•"ç²¾ç»†åŒ–ä½¿ç”¨åœºæ™¯"ï¼šä¸ºè¯¥å…¸å‹äººç¾¤è®¾è®¡1-2ä¸ªå…·ä½“ã€ç”ŸåŠ¨çš„ä½¿ç”¨åœºæ™¯ã€‚\n    - å®šåˆ¶"å°çº¢ä¹¦æ ¸å¿ƒè¯æœ¯"ï¼šä¸ºæ¯ä¸ªç²¾ç»†åŒ–åœºæ™¯æ’°å†™é€‚åˆå°çº¢ä¹¦å¹³å°çš„å…³é”®å–ç‚¹è¡¨è¾¾è¯æœ¯ï¼Œè¦æ±‚ï¼š\n      * è¯æœ¯ç²¾å‡†æ•æ‰å…¸å‹äººç¾¤å…³æ³¨ç‚¹å’Œè¯­è¨€ä¹ æƒ¯ï¼Œæ¿€å‘äº’åŠ¨æ¬²æœ›ï¼Œå…·å¤‡å¼ºç§è‰èƒ½åŠ›ï¼Œé£æ ¼è‡ªç„¶çœŸå®ï¼Œé¿å…è¿‡åº¦è¥é”€ã€‚\n2. è¾“å‡ºè¦æ±‚ï¼š\n  - åˆ†æç»“æœä¸åˆ›ä½œå†…å®¹æ•´åˆè¾“å‡ºä¸ºå•ä¸€JSONå¯¹è±¡ï¼Œå‘½åä¸º"æ•´åˆäººç¾¤åœºæ™¯æ´å¯Ÿ"ã€‚\n  - JSONç»“æ„éœ€æ¸…æ™°å±•ç¤ºï¼šåŸå§‹ä¼˜è´¨äººç¾¤åˆ†ç»„ã€æ‹“å±•å‡ºçš„å…¸å‹äººç¾¤ã€æ¯ä¸ªå…¸å‹äººç¾¤çš„éœ€æ±‚ç—›ç‚¹ã€åŒ¹é…å–ç‚¹ã€ç²¾ç»†åŒ–åœºæ™¯åŠå…¶å°çº¢ä¹¦æ ¸å¿ƒè¯æœ¯ã€‚\n3. æ€»ä½“è¦æ±‚ï¼š\n  - ç¡®ä¿è¾“å‡ºJSONç»“æ„æ¸…æ™°ã€æ˜“äºè§£æã€‚\n  - æ‰€æœ‰æè¿°æ€§å†…å®¹è¯¦å°½ã€ç”ŸåŠ¨ã€å…·æœ‰ä»£å…¥æ„Ÿï¼Œä¾¿äºåç»­ç›´æ¥ç”¨äºè¥é”€ç­–ç•¥å’Œå†…å®¹åˆ›ä½œã€‚\n  - å……åˆ†åˆ©ç”¨æ‰€æœ‰è¾“å…¥æ•°æ®ï¼Œè¿›è¡Œæœ‰æ´å¯ŸåŠ›çš„åˆ†æå’Œåˆ›é€ æ€§æ‹“å±•ã€‚\n  - å…¨ç¨‹ä½¿ç”¨ä¸­æ–‡ã€‚\nã€æ ¼å¼è¦æ±‚ã€‘ä¸¥æ ¼è¾“å‡ºåˆæ³•JSONï¼Œä¸è¦æœ‰å¤šä½™æ³¨é‡Šã€ä¸è¦æœ‰å¤šä½™æ–‡æœ¬ã€ä¸è¦æœ‰å¤šä½™çš„markdownä»£ç å—æ ‡è®°ï¼ˆå¦‚\`\`\`jsonï¼‰ã€‚`;
            }

            // å¹¶å‘å¤„ç†5ä¸ªäººç¾¤
            const CONCURRENT_LIMIT = 5;
            let allInsights = [];
            let failedCrowds = []; // è®°å½•å¤±è´¥çš„äººç¾¤
            let idx = 0;
            
            while (idx < highScorerSamples.length) {
                const currentGroup = highScorerSamples.slice(idx, idx + CONCURRENT_LIMIT);
                const promises = currentGroup.map(async (crowd, i) => {
                    let retry = 0;
                    const maxRetries = 3;
                    
                    while (retry < maxRetries) {
                        try {
                            const prompt = buildPrompt(crowd);
                            const result = await callGeminiAPI(prompt, true, 'scene');
                            // å…¼å®¹ä¸åŒè¿”å›ç»“æ„
                            let sceneList = [];
                            if (result && result.result && Array.isArray(result.result.æ•´åˆäººç¾¤åœºæ™¯æ´å¯Ÿ)) {
                                sceneList = result.result.æ•´åˆäººç¾¤åœºæ™¯æ´å¯Ÿ;
                            } else if (result && Array.isArray(result.æ•´åˆäººç¾¤åœºæ™¯æ´å¯Ÿ)) {
                                sceneList = result.æ•´åˆäººç¾¤åœºæ™¯æ´å¯Ÿ;
                            } else {
                                sceneList = [];
                            }
                            if (sceneList.length > 0) {
                                allInsights.push(sceneList[0]);
                                console.log(`âœ… äººç¾¤"${crowd?.groupName || sceneList[0]?.åŸå§‹ä¼˜è´¨äººç¾¤?.groupName || 'æœªçŸ¥äººç¾¤'}"å¤„ç†æˆåŠŸ`);
                                return; // æˆåŠŸåˆ™é€€å‡ºé‡è¯•å¾ªç¯
                            } else {
                                throw new Error('APIè¿”å›æ•°æ®æ ¼å¼ä¸æ­£ç¡®');
                            }
                        } catch (error) {
                            retry++;
                            if (retry >= maxRetries) {
                                failedCrowds.push({ ...crowd, error: error.message });
                                console.warn(`âŒ äººç¾¤"${crowd?.groupName || 'æœªçŸ¥äººç¾¤'}"å¤„ç†å¤±è´¥:`, error.message);
                                return;
                            } else {
                                await new Promise(res => setTimeout(res, 1000 * retry));
                            }
                        }
                    }
                });
                await Promise.all(promises);
                idx += CONCURRENT_LIMIT;
            }

            // è¾“å‡ºå¤±è´¥ç»Ÿè®¡
            if (failedCrowds.length > 0) {
                console.log(`\nğŸ“Š èŠ‚ç‚¹7å¤„ç†å®Œæˆç»Ÿè®¡:`);
                console.log(`âœ… æˆåŠŸå¤„ç†: ${allInsights.length}ä¸ªäººç¾¤`);
                console.log(`âŒ å¤±è´¥è·³è¿‡: ${failedCrowds.length}ä¸ªäººç¾¤`);
                console.log(`ğŸ“‹ å¤±è´¥äººç¾¤åˆ—è¡¨:`);
                failedCrowds.forEach((crowd, index) => {
                    console.log(`   ${index + 1}. "${crowd.groupName}" - é”™è¯¯: ${crowd.error}`);
                });
                console.log(`\nğŸ’¡ å»ºè®®: å¤±è´¥çš„äººç¾¤å¯èƒ½æ˜¯ç”±äºAPIé…é¢é™åˆ¶æˆ–ç½‘ç»œé—®é¢˜ï¼Œå»ºè®®ç¨åé‡è¯•æˆ–æ£€æŸ¥APIé…ç½®`);
            } else {
                console.log(`\nğŸ‰ èŠ‚ç‚¹7å¤„ç†å®Œæˆ: æ‰€æœ‰${allInsights.length}ä¸ªäººç¾¤éƒ½å¤„ç†æˆåŠŸï¼`);
            }

            // æ•°æ®å¤„ç†ä¸è¾“å‡º
            const dataForExcel = [];
            
            // å¦‚æœAPIè°ƒç”¨å…¨éƒ¨å¤±è´¥ï¼Œç”ŸæˆåŸºç¡€æ•°æ®é¿å…å‰ç«¯æŠ¥é”™
            if (allInsights.length === 0 && failedCrowds.length > 0) {
                console.warn('âš ï¸ æ‰€æœ‰APIè°ƒç”¨éƒ½å¤±è´¥äº†ï¼Œç”ŸæˆåŸºç¡€æ•°æ®é¿å…å‰ç«¯æŠ¥é”™');
                failedCrowds.forEach((crowd, index) => {
                    dataForExcel.push({
                        'äººç¾¤ç±»åˆ«': crowd.groupName || 'æœªçŸ¥äººç¾¤',
                        'å…¸å‹äººç¾¤': 'APIè°ƒç”¨å¤±è´¥',
                        'éœ€æ±‚ç—›ç‚¹': 'ç½‘ç»œè¿æ¥é—®é¢˜å¯¼è‡´æ— æ³•ç”Ÿæˆ',
                        'åŒ¹é…å–ç‚¹': 'è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•',
                        'ç²¾ç»†åŒ–åœºæ™¯': 'APIè°ƒç”¨å¤±è´¥: ç½‘ç»œè¿æ¥ä¸­æ–­',
                        'æ ¸å¿ƒè¡¨è¾¾æ–‡æ¡ˆ': 'å»ºè®®ç¨åé‡è¯•æˆ–æ£€æŸ¥APIé…ç½®',
                    });
                });
            } else {
                // æ­£å¸¸å¤„ç†æˆåŠŸçš„æ•°æ®
                allInsights.forEach((group, idx) => {
                    // åŠ å¼ºæ•°æ®æ ¡éªŒï¼Œé‡åˆ°å¼‚å¸¸æ—¶è¯¦ç»†æ‰“å°æ—¥å¿—å¹¶è·³è¿‡
                    if (!group) {
                        console.warn(`â— allInsights[${idx}] ä¸º undefinedï¼Œè·³è¿‡ã€‚åŸå§‹å†…å®¹:`, group);
                        return;
                    }
                    if (!group.æ‹“å±•å…¸å‹äººç¾¤ || !Array.isArray(group.æ‹“å±•å…¸å‹äººç¾¤)) {
                        console.warn(`â— allInsights[${idx}] ç¼ºå°‘æ‹“å±•å…¸å‹äººç¾¤å­—æ®µæˆ–ç±»å‹ä¸å¯¹ï¼Œè·³è¿‡ã€‚åŸå§‹å†…å®¹:`, group);
                        return;
                    }
                    try {
                        group.æ‹“å±•å…¸å‹äººç¾¤.forEach(persona => {
                            // æ£€æŸ¥personaæ˜¯å¦å­˜åœ¨ä¸”ç²¾ç»†åŒ–ä½¿ç”¨åœºæ™¯æ˜¯å¦ä¸ºæ•°ç»„
                            if(!persona || !persona.ç²¾ç»†åŒ–ä½¿ç”¨åœºæ™¯ || !Array.isArray(persona.ç²¾ç»†åŒ–ä½¿ç”¨åœºæ™¯)) return;
                            try {
                                persona.ç²¾ç»†åŒ–ä½¿ç”¨åœºæ™¯.forEach(scene => {
                                    // æ£€æŸ¥sceneæ˜¯å¦å­˜åœ¨ä¸”åŒ…å«å¿…è¦å­—æ®µ
                                    if(!scene || !scene.åœºæ™¯åç§° || !scene.åœºæ™¯æè¿° || !scene.å°çº¢ä¹¦æ ¸å¿ƒè¯æœ¯) return;
                                    dataForExcel.push({
                                        'äººç¾¤ç±»åˆ«': group.åŸå§‹ä¼˜è´¨äººç¾¤?.groupName || 'æœªçŸ¥äººç¾¤',
                                        'å…¸å‹äººç¾¤': persona.å…¸å‹äººç¾¤åç§° || 'æœªçŸ¥å…¸å‹äººç¾¤',
                                        'éœ€æ±‚ç—›ç‚¹': persona.éœ€æ±‚ç—›ç‚¹ || 'æœªæä¾›',
                                        'åŒ¹é…å–ç‚¹': persona.åŒ¹é…äº§å“å–ç‚¹ || 'æœªæä¾›',
                                        'ç²¾ç»†åŒ–åœºæ™¯': `${scene.åœºæ™¯åç§°}: ${scene.åœºæ™¯æè¿°}`,
                                        'æ ¸å¿ƒè¡¨è¾¾æ–‡æ¡ˆ': scene.å°çº¢ä¹¦æ ¸å¿ƒè¯æœ¯,
                                    });
                                });
                            } catch (sceneError) {
                                // æ•è·ç²¾ç»†åŒ–ä½¿ç”¨åœºæ™¯å¤„ç†å¼‚å¸¸
                                console.warn('ç²¾ç»†åŒ–ä½¿ç”¨åœºæ™¯å¤„ç†å¼‚å¸¸:', sceneError);
                            }
                        });
                    } catch (e) {
                        // æ•è·æ‹“å±•å…¸å‹äººç¾¤å¤„ç†å¼‚å¸¸ï¼Œé¿å…å‰ç«¯æŠ¥é”™
                        console.warn('æ‹“å±•å…¸å‹äººç¾¤å¤„ç†å¼‚å¸¸:', e);
                    }
                });
            }
            
            // ç¡®ä¿è‡³å°‘æœ‰åŸºç¡€æ•°æ®ï¼Œé¿å…å‰ç«¯æŠ¥é”™
            if (dataForExcel.length === 0) {
                console.warn('âš ï¸ æ²¡æœ‰ç”Ÿæˆä»»ä½•æ•°æ®ï¼Œåˆ›å»ºé»˜è®¤è®°å½•é¿å…å‰ç«¯æŠ¥é”™');
                dataForExcel.push({
                    'äººç¾¤ç±»åˆ«': 'ç³»ç»Ÿæç¤º',
                    'å…¸å‹äººç¾¤': 'æ•°æ®å¤„ç†å®Œæˆ',
                    'éœ€æ±‚ç—›ç‚¹': 'APIè°ƒç”¨å¯èƒ½å­˜åœ¨é—®é¢˜',
                    'åŒ¹é…å–ç‚¹': 'è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å’ŒAPIé…ç½®',
                    'ç²¾ç»†åŒ–åœºæ™¯': 'å»ºè®®ç¨åé‡è¯•æˆ–è”ç³»æŠ€æœ¯æ”¯æŒ',
                    'æ ¸å¿ƒè¡¨è¾¾æ–‡æ¡ˆ': 'å·¥ä½œæµæ‰§è¡Œå®Œæˆï¼Œä½†æ•°æ®ç”Ÿæˆå¯èƒ½ä¸å®Œæ•´',
                });
            }

            return { ...state, åœºæ™¯æ´å¯Ÿ: { data: dataForExcel, raw: allInsights } };
        }
        
        async function runNode8(state) {
            workflowState.currentNodeId = 8;
            workflowState.currentNodeName = "ç”Ÿæˆå¯äº¤ä»˜çš„Excelè¥é”€åœºæ™¯è¡¨";
            console.log("èŠ‚ç‚¹ 8: æœ¬åœ°æ•°æ®å¤„ç† - å‡†å¤‡æœ€ç»ˆä¸‹è½½æ–‡ä»¶...");
            
            // è·å–äº§å“åç§°ä½œä¸ºå‰ç¼€
            const productName = getProductName();
            const prefix = `[${productName}]`;
            
            const downloads = [
                { name: `${prefix}[å–ç‚¹]äº§å“å–ç‚¹.md`, content: { title: `äº§å“å–ç‚¹`, data: state.äº§å“å–ç‚¹ }, type: 'markdown' },
                { name: `${prefix}KOLåª’ä»‹ç­–ç•¥.md`, content: state.KOLåª’ä»‹ç­–ç•¥, type: 'markdown' },
                { name: `${prefix}å†…å®¹åˆ›ä½œç­–ç•¥ä»¥åŠå®¡ç¨¿è§„åˆ™.md`, content: state.å†…å®¹åˆ›ä½œç­–ç•¥åŠå®¡ç¨¿è§„åˆ™, type: 'markdown' },
                { name: `${prefix}[äººç¾¤]é«˜åˆ†.xlsx`, content: state.äººç¾¤é«˜åˆ†, type: 'excel' },
                { name: `${prefix}[åœºæ™¯æ´å¯Ÿ].xlsx`, content: state.åœºæ™¯æ´å¯Ÿ, type: 'excel' }
            ];
            return { ...state, finalDownloads: downloads };
        }
        
        function initializeDefaultFileNames() {
            templateAllAudienceFeedback.textContent = 'é»˜è®¤: å…¨é‡äººç¾¤.json';
            templateAllAudienceFeedback.style.color = '#6b7280'; 
            templateHighScoreAudienceFeedback.textContent = 'é»˜è®¤: [äººç¾¤]æ¨¡æ¿.json';
            templateHighScoreAudienceFeedback.style.color = '#6b7280';
            templateSceneInsightFeedback.textContent = 'é»˜è®¤: [åœºæ™¯æ´å¯Ÿ]æ¨¡æ¿.json';
            templateSceneInsightFeedback.style.color = '#6b7280';
        }

        // --- INITIALIZATION ---
        async function initialize() {
            initStatusUI();
            initializeDefaultFileNames();
            await loadFullAudienceData();
        }

        // å¯åŠ¨åˆå§‹åŒ–
        initialize();

        // --- æ–‡ä»¶ä¸Šä¼ è§£æ ---
        document.getElementById('custom-core-crowds').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(evt) {
                const data = new Uint8Array(evt.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const json = XLSX.utils.sheet_to_json(firstSheet);
                fileCache['è‡ªå®šä¹‰æ ¸å¿ƒäººç¾¤.xlsx'] = json;
                document.getElementById('custom-core-crowds-feedback').textContent = `å·²åŠ è½½: ${file.name} (${json.length}æ¡)`;
                document.getElementById('custom-core-crowds-feedback').style.color = '#16a34a';
            };
            reader.readAsArrayBuffer(file);
        });
    </script>

</body>
</html>